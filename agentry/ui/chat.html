<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Agentry - Your AI Assistant">
    <title>Agentry</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        /* Marked/Highlight.js Overrides for Message Content */
        .message-text {
            line-height: 1.6;
        }

        .message-text h1,
        .message-text h2,
        .message-text h3 {
            margin-top: 16px;
            margin-bottom: 8px;
            color: var(--accent-cyan);
            font-weight: 700;
        }

        .message-text h1 {
            font-size: 1.4em;
        }

        .message-text h2 {
            font-size: 1.25em;
        }

        .message-text h3 {
            font-size: 1.1em;
        }

        .message-text p {
            margin-bottom: 12px;
        }

        .message-text pre {
            background: #282c34 !important;
            /* One Dark bg */
            border-radius: 8px;
            margin: 12px 0;
            padding: 12px;
            overflow-x: auto;
            border: 1px solid var(--dark-border);
            white-space: pre;
            word-wrap: normal;
        }

        .message-text code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        .message-text p code,
        .message-text li code {
            background: rgba(212, 175, 55, 0.15);
            /* Gold tint */
            padding: 2px 5px;
            border-radius: 4px;
            color: var(--accent-cyan);
        }

        .message-text ul,
        .message-text ol {
            margin-left: 20px;
            margin-bottom: 12px;
        }

        .message-text blockquote {
            border-left: 4px solid var(--accent-cyan);
            margin: 12px 0;
            padding-left: 12px;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* ===== Copyable Content Block Styles ===== */

        /* Code Block Container with Header */
        .code-block-container {
            position: relative;
            margin: 12px 0;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--dark-border);
            background: #282c34;
        }

        .code-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid var(--dark-border);
        }

        .code-block-language {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: lowercase;
            font-family: 'JetBrains Mono', monospace;
        }

        .copy-block-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            background: transparent;
            border: 1px solid var(--dark-border);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .copy-block-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border-color: var(--accent-cyan);
        }

        .copy-block-btn.copied {
            background: rgba(123, 158, 99, 0.2);
            color: var(--success-color);
            border-color: var(--success-color);
        }

        .copy-block-btn svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        .code-block-container pre {
            margin: 0 !important;
            border: none !important;
            border-radius: 0 !important;
        }

        /* Custom Horizontal Scrollbar for Code, Tables, and Tool Calls */

        /* Common Dimensions & Track */
        .code-block-container pre::-webkit-scrollbar,
        .message-text pre::-webkit-scrollbar,
        .table-scroll-wrapper::-webkit-scrollbar,
        .tool-call-args::-webkit-scrollbar,
        .tool-call-result::-webkit-scrollbar,
        .approval-args::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }

        .code-block-container pre::-webkit-scrollbar-track,
        .message-text pre::-webkit-scrollbar-track,
        .table-scroll-wrapper::-webkit-scrollbar-track,
        .tool-call-args::-webkit-scrollbar-track,
        .tool-call-result::-webkit-scrollbar-track,
        .approval-args::-webkit-scrollbar-track {
            background: transparent;
        }

        /* Always Dark Content (Code Blocks) */
        .code-block-container pre::-webkit-scrollbar-thumb,
        .message-text pre::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        .code-block-container pre::-webkit-scrollbar-thumb:hover,
        .message-text pre::-webkit-scrollbar-thumb:hover {
            background: #777;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        /* Theme-Aware Content (Tables, Tool Calls) */
        .table-scroll-wrapper::-webkit-scrollbar-thumb,
        .tool-call-args::-webkit-scrollbar-thumb,
        .tool-call-result::-webkit-scrollbar-thumb,
        .approval-args::-webkit-scrollbar-thumb {
            background: var(--text-muted);
            border-radius: 4px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        .table-scroll-wrapper::-webkit-scrollbar-thumb:hover,
        .tool-call-args::-webkit-scrollbar-thumb:hover,
        .tool-call-result::-webkit-scrollbar-thumb:hover,
        .approval-args::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
            border: 2px solid transparent;
            background-clip: content-box;
        }

        /* Table Container with Header Bar (like code blocks) */
        .table-container {
            position: relative;
            margin: 16px 0;
            display: block;
            max-width: 100%;
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            overflow: hidden;
            background: var(--dark-card);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid var(--dark-border);
            min-height: 36px;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .table-header-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary) !important;
            font-family: 'JetBrains Mono', monospace;
            text-transform: lowercase;
            display: inline-block !important;
            flex-shrink: 0;
        }

        .table-header .copy-block-btn {
            margin-left: auto;
            opacity: 1;
            flex-shrink: 0;
        }

        .table-container .copy-block-btn {
            opacity: 1;
        }

        .table-scroll-wrapper {
            overflow-x: auto;
            max-width: 100%;
        }

        .table-container table {
            margin: 0;
            border: none;
            border-radius: 0;
            min-width: 100%;
        }

        .table-container th:first-child,
        .table-container td:first-child {
            border-left: none;
        }

        .table-container th:last-child,
        .table-container td:last-child {
            border-right: none;
        }

        .table-container tr:last-child td {
            border-bottom: none;
        }

        /* Blockquote Container with Copy Button */
        .blockquote-container {
            position: relative;
        }

        .blockquote-container .copy-block-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            opacity: 0;
            transition: opacity 0.2s ease;
            padding: 3px 8px;
            font-size: 11px;
        }

        .blockquote-container:hover .copy-block-btn {
            opacity: 1;
        }

        :root {
            /* Modern Minimal Theme - Light (default to match landing page) */
            /* Colors - Using common.css naming conventions */
            --bg-primary: #fafafa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f4f4f5;
            --text-primary: #0a0a0a;
            --text-secondary: #525252;
            --text-muted: #a3a3a3;

            /* Cards & Components */
            --card-bg: rgba(255, 255, 255, 0.7);
            --card-border: rgba(0, 0, 0, 0.08);
            --card-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);

            /* Accent */
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.4);
            --accent-light: rgba(99, 102, 241, 0.1);

            /* Status */
            --success: #22c55e;
            --error: #ef4444;
            --warning: #f59e0b;

            /* Input */
            --input-bg: #ffffff;
            --input-border: rgba(0, 0, 0, 0.12);
            --input-focus: var(--accent);

            /* Backwards compatibility aliases */
            --gradient-start: var(--accent);
            --gradient-end: #8b5cf6;
            --accent-cyan: var(--accent);
            --accent-pink: #ec4899;
            --dark-bg: var(--bg-primary);
            --dark-card: var(--bg-secondary);
            --dark-sidebar: var(--bg-tertiary);
            --dark-input: var(--input-bg);
            --dark-border: var(--card-border);
            --error-color: var(--error);
            --success-color: var(--success);
            --tool-color: var(--accent);
        }

        [data-theme="dark"] {
            /* Dark Theme */
            --bg-primary: #09090b;
            --bg-secondary: #18181b;
            --bg-tertiary: #27272a;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #52525b;

            --card-bg: rgba(24, 24, 27, 0.7);
            --card-border: rgba(255, 255, 255, 0.08);
            --card-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);

            --accent: #818cf8;
            --accent-glow: rgba(129, 140, 248, 0.5);
            --accent-light: rgba(129, 140, 248, 0.15);

            --input-bg: #18181b;
            --input-border: rgba(255, 255, 255, 0.1);

            /* Backwards compatibility aliases */
            --gradient-start: var(--accent);
            --dark-bg: var(--bg-primary);
            --dark-card: var(--bg-secondary);
            --dark-sidebar: #0f0f11;
            --dark-input: #1f1f23;
            --dark-border: var(--card-border);
            --tool-color: var(--accent);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--dark-bg);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* Global Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--text-muted);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Firefox scrollbar styling for all scrollable containers */
        .messages-container,
        .sessions-container,
        .table-scroll-wrapper {
            scrollbar-width: thin;
            scrollbar-color: var(--text-muted) transparent;
        }

        .code-block-container pre,
        .message-text pre {
            scrollbar-width: thin;
            scrollbar-color: #555 transparent;
        }

        /* --- Premium Loaders --- */

        /* Option 1: Quantum Ring (Sleek, Sci-Fi) */
        .spinner-quantum {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid transparent;
            border-top-color: #3b82f6;
            /* Blue-500 */
            animation: spin-quantum 1s linear infinite;
            position: relative;
            margin: 10px;
        }

        .spinner-quantum::before {
            content: "";
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            border-radius: 50%;
            border: 2px solid transparent;
            border-top-color: #8b5cf6;
            /* Violet-500 */
            animation: spin-quantum 2s linear infinite reverse;
        }

        .spinner-quantum::after {
            content: "";
            position: absolute;
            top: 6px;
            left: 6px;
            right: 6px;
            bottom: 6px;
            border-radius: 50%;
            border: 2px solid transparent;
            border-top-color: #10b981;
            /* Emerald-500 */
            animation: spin-quantum 1.5s linear infinite;
        }

        @keyframes spin-quantum {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Option 2: Neon Wave (Voice/Data) */
        .spinner-wave {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 4px;
            height: 24px;
            margin: 10px 0 10px 10px;
        }

        .spinner-wave div {
            width: 3px;
            height: 100%;
            background: linear-gradient(to top, #3b82f6, #60a5fa);
            animation: wave 1s ease-in-out infinite;
            border-radius: 2px;
        }

        .spinner-wave div:nth-child(2) {
            animation-delay: 0.1s;
        }

        .spinner-wave div:nth-child(3) {
            animation-delay: 0.2s;
        }

        .spinner-wave div:nth-child(4) {
            animation-delay: 0.3s;
        }

        .spinner-wave div:nth-child(5) {
            animation-delay: 0.4s;
        }

        @keyframes wave {

            0%,
            100% {
                height: 30%;
                opacity: 0.5;
            }

            50% {
                height: 100%;
                opacity: 1;
                box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
            }
        }

        /* Option 3: Retro Terminal (Glitch) */
        .spinner-retro {
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            color: #10b981;
            margin: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .spinner-retro-cursor {
            width: 8px;
            height: 16px;
            background-color: #10b981;
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }

        /* Option 4: Orbital Dots (Playful, Modern) */
        .spinner-orbital {
            width: 32px;
            height: 32px;
            position: relative;
            animation: spin-orbital 2s infinite linear;
            margin: 10px;
        }

        .spinner-orbital .dot {
            width: 60%;
            height: 60%;
            display: inline-block;
            position: absolute;
            top: 0;
            background-color: #3b82f6;
            border-radius: 100%;
            animation: spin-orbital-bounce 2s infinite ease-in-out;
        }

        .spinner-orbital .dot:nth-child(2) {
            top: auto;
            bottom: 0;
            animation-delay: -1.0s;
            background-color: #8b5cf6;
        }

        @keyframes spin-orbital {
            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes spin-orbital-bounce {

            0%,
            100% {
                transform: scale(0.0);
            }

            50% {
                transform: scale(1.0);
            }
        }

        /* Option 5: Pulse Echo (Minimalist) */
        .spinner-pulse {
            width: 32px;
            height: 32px;
            margin: 10px;
            background-color: #3b82f6;
            border-radius: 100%;
            animation: scaleout 1.0s infinite ease-in-out;
        }

        @keyframes scaleout {
            0% {
                transform: scale(0);
            }

            100% {
                transform: scale(1.0);
                opacity: 0;
            }
        }

        /* Option 6: Bars Shuffle (Classic Digital) */
        .spinner-bars {
            width: 32px;
            height: 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px;
        }

        .spinner-bars div {
            width: 6px;
            height: 32px;
            background-color: #10b981;
            animation: bars-shuffle 1.2s infinite ease-in-out;
            border-radius: 2px;
        }

        .spinner-bars div:nth-child(2) {
            animation-delay: -1.1s;
        }

        .spinner-bars div:nth-child(3) {
            animation-delay: -1.0s;
        }

        @keyframes bars-shuffle {

            0%,
            40%,
            100% {
                transform: scaleY(0.4);
            }

            20% {
                transform: scaleY(1.0);
            }
        }



        /* Scroll to Bottom Button */
        .scroll-bottom-btn {
            position: absolute;
            bottom: 110px;
            right: 32px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(var(--bg-secondary-rgb, 40, 44, 52), 0.8);
            backdrop-filter: blur(8px);
            border: 1px solid var(--card-border);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(10px);
        }

        .scroll-bottom-btn.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .scroll-bottom-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            box-shadow: 0 0 15px var(--accent-glow);
            transform: scale(1.1);
        }

        .scroll-bottom-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Layout */
        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            min-width: 240px;
            /* Minimum width constraints */
            max-width: 500px;
            background: var(--dark-sidebar);
            border-right: 1px solid var(--dark-border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            position: relative;
            /* For resizer positioning */
            transition: width 0.1s ease;
            /* Smooth resize only when not dragging, handled in JS */
        }

        .sidebar.collapsed {
            width: 0px;
            min-width: 0;
            overflow: hidden;
            border-right: none;
        }

        /* Resizer Handle */
        .sidebar-resizer {
            position: absolute;
            right: -4px;
            top: 0;
            bottom: 0;
            width: 8px;
            cursor: col-resize;
            z-index: 10;
            opacity: 0;
            /* Default hidden */
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Visible grip on hover or when resizing */
        .sidebar:hover .sidebar-resizer,
        .sidebar-resizer:hover {
            opacity: 1;
        }

        .sidebar-resizer::after {
            content: "";
            width: 4px;
            height: 40px;
            background: var(--tool-color);
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
        }

        /* Expander/Collapse Button Container */
        /* Expander/Collapse Button Container */
        .sidebar-toggle-area {
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            z-index: 20;
            display: none;
        }

        /* .sidebar.collapsed + .chat-main .chat-header {
            padding-left: 60px; 
            transition: padding-left 0.2s;
        } Removed padding hack */

        .sidebar-toggle-btn {
            background: var(--dark-sidebar);
            border: 1px solid var(--dark-border);
            border-left: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 18px;
            padding: 16px 4px;
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 4px 0 12px rgba(0, 0, 0, 0.2);
        }

        .sidebar.collapsed+.chat-main .sidebar-toggle-area {
            display: block;
        }

        .sidebar-toggle-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 18px;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-toggle-btn:hover {
            background: var(--dark-input);
            color: var(--accent-cyan);
        }

        /* Sidebar Header Toggle */
        .sidebar-header-toggle {
            margin-left: auto;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--dark-border);
            color: var(--text-secondary);
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }

        .sidebar-header-toggle:hover {
            background: var(--dark-input);
            color: var(--accent-cyan);
            border-color: var(--accent-cyan);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.2);
        }

        .sidebar-header {
            padding: 0;
            border-bottom: none;
            display: flex;
            flex-direction: column;
            background: transparent;
        }

        .logo-header-wrapper {
            padding: 16px 12px 8px 20px;
            display: flex;
            align-items: center;
            width: 100%;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 0;
            flex: 1;
        }

        .logo-img {
            height: 36px;
            width: auto;
            object-fit: contain;
        }

        .logo-icon {
            width: 28px;
            height: 28px;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .logo-icon svg {
            width: 28px;
            height: 28px;
            fill: var(--text-primary);
        }

        .logo-text {
            font-size: 16px;
            font-weight: 600;
            letter-spacing: -0.02em;
            color: var(--text-primary);
        }

        /* Assistant avatar with logo */
        .assistant-avatar-img {
            width: 32px;
            height: 32px;
            object-fit: contain;
            border-radius: 8px;
        }

        .new-chat-btn {
            flex: 1;
            padding: 10px 16px;
            background: var(--dark-input);
            color: var(--text-primary);
            border: 1px solid var(--dark-border);
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .new-chat-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
        }

        .new-chat-btn:active {
            transform: scale(0.98);
        }

        /* Sidebar Action Buttons Row */
        .sidebar-actions-row {
            display: flex;
            flex-direction: column;
            gap: 3.2px;
            margin-top: 4px;
            margin-bottom: 12px;
            padding: 0 8px;
        }

        .sidebar-action-btn {
            width: 100%;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14.63px;
            font-weight: 400;
            color: var(--text-primary);
            font-family: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
            background: transparent;
            border: none;
            transition: background 0.2s ease;
            text-align: left;
        }

        .btn-icon-wrapper {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: var(--text-primary);
        }

        .btn-icon-wrapper svg {
            color: var(--text-primary);
        }

        .sidebar-action-btn:hover {
            background: var(--dark-input);
        }



        .sidebar-action-btn.active {
            background-color: rgba(147, 51, 234, 0.1);
            color: var(--accent-purple);
        }

        .sidebar-action-btn svg {
            width: 16px;
            height: 16px;
            opacity: 0.9;
            flex-shrink: 0;
        }

        /* Sessions List */
        .sessions-container {
            flex: 1;
            overflow-y: auto;
            padding: 4px 8px;
        }

        .sessions-container::-webkit-scrollbar {
            width: 6px;
        }

        .sessions-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .sessions-container::-webkit-scrollbar-thumb {
            background: var(--dark-border);
            border-radius: 3px;
        }

        .session-item {
            padding: 8px 10px;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 1px;
            transition: all 0.15s;
        }

        .session-item:hover {
            background: var(--dark-input);
        }

        .session-item.active {
            background: rgba(102, 126, 234, 0.15);
            border-color: var(--gradient-start);
        }

        .session-title {
            font-size: 14px;
            font-weight: 400;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .session-date {
            font-size: 11px;
            color: var(--text-muted);
        }

        .session-delete {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .session-item:hover .session-delete {
            opacity: 1;
        }

        .session-delete:hover {
            background: var(--error-color);
            color: white;
        }

        .session-item {
            position: relative;
            padding-right: 32px;
        }

        /* Search Modal Styles */
        .search-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding-top: 8vh;
            z-index: 10000;
            animation: fadeIn 0.2s ease-out;
        }

        .search-modal-overlay.active {
            display: flex;
        }

        .search-modal {
            background: var(--bg-primary);
            width: 680px;
            max-width: 95vw;
            max-height: 80vh;
            border-radius: 16px;
            border: 1px solid var(--card-border);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: slideDown 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .search-modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--card-border);
            background: var(--bg-secondary);
        }

        .modal-search-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--dark-input);
            border: 1px solid var(--dark-border);
            border-radius: 12px;
            padding: 12px 18px;
            transition: all 0.2s;
        }

        .modal-search-wrapper:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-light);
        }

        .modal-search-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
            outline: none;
        }

        .search-modal-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            background: var(--bg-primary);
        }

        .modal-sessions-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .modal-session-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .modal-session-item:hover {
            background: var(--bg-secondary);
            border-color: var(--card-border);
        }

        .modal-session-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--dark-input);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .modal-session-info {
            flex: 1;
            min-width: 0;
        }

        .modal-session-title {
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }

        .modal-session-meta {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-session-snippet {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
            font-style: italic;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .modal-match-badge {
            font-size: 10px;
            padding: 1px 6px;
            border-radius: 4px;
            background: var(--accent-light);
            color: var(--accent);
            font-weight: 600;
            text-transform: uppercase;
        }

        .modal-no-results {
            padding: 40px;
            text-align: center;
            color: var(--text-secondary);
        }

        /* Sessions Header */
        .sessions-header {
            padding: 12px 12px 6px 12px;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: capitalize;
            letter-spacing: 0;
        }

        /* Provider Info */
        .sidebar-footer {
            padding: 8px 10px;
            border-top: 1px solid var(--card-border);
        }

        .provider-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .provider-info:hover {
            background: var(--bg-secondary);
        }

        .provider-icon-small {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: transparent;
            flex-shrink: 0;
        }

        .provider-icon-small img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .provider-details {
            flex: 1;
            min-width: 0;
            /* overflow: hidden; Removed to allow tooltip to show */
        }

        .provider-name-small {
            font-size: 13px;
            font-weight: 500;
        }

        .model-name-small {
            font-size: 10px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .model-info-row {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .capabilities-info-btn {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 1px solid var(--card-border);
            color: var(--text-muted);
            font-size: 9px;
            font-weight: 600;
            cursor: help;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .capabilities-info-btn:hover {
            background: var(--accent-light);
            border-color: var(--accent);
            color: var(--accent);
        }

        .capabilities-tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            padding: 8px 10px;
            min-width: 140px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 1000;
            pointer-events: none;
        }

        .capabilities-info-btn:hover .capabilities-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .capabilities-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--card-border);
        }

        .capabilities-tooltip::before {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: var(--bg-secondary);
            z-index: 1;
        }

        .capabilities-tooltip-title {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .capabilities-list {
            margin: 0;
            padding-left: 16px;
            list-style-type: disc;
        }

        .capability-item {
            font-size: 11px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .capability-item.supported {
            color: #22c55e;
            font-weight: 600;
        }

        .capability-item.not-supported {
            color: var(--text-muted);
            opacity: 0.7;
        }


        .change-btn {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
            background: var(--dark-input);
            padding: 4px 8px;
            border-radius: 4px;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .change-btn:hover {
            color: var(--text-primary);
            background: var(--dark-card);
        }

        /* User Menu */
        .user-menu {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            margin-top: 4px;
            background: transparent;
            border-radius: 8px;
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            background: #7c3aed;
            color: #ffffff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            flex-shrink: 0;
        }

        .user-name {
            flex: 1;
            font-size: 13px;
            font-weight: 500;
        }

        .logout-btn {
            padding: 5px 10px;
            background: var(--dark-input);
            border: 1px solid var(--dark-border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 11px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .logout-btn:hover {
            background: var(--dark-card);
            border-color: var(--text-muted);
            color: var(--text-primary);
        }

        /* Main Chat Area */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--dark-bg);
        }

        /* Chat Header - Using CSS Grid for perfect centering */
        .chat-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--dark-bg);
            padding: 16px 24px;
            border-bottom: 1px solid var(--dark-border);
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }

        .header-logo {
            display: none;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--text-primary);
            transition: opacity 0.2s ease;
        }

        .header-logo:hover {
            opacity: 0.8;
        }

        .header-logo .logo-icon {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header-logo .logo-icon svg {
            width: 16px;
            height: 16px;
            stroke: white;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        @keyframes shine {
            0% {
                background-position: 100%;
            }

            100% {
                background-position: -100%;
            }
        }

        .shiny-text {
            font-weight: 700;
            letter-spacing: -0.5px;
            color: transparent;
            background: linear-gradient(120deg,
                    var(--text-primary) 40%,
                    var(--accent-light, #ffffff) 50%,
                    var(--text-primary) 60%);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            display: inline-block;
            animation: shine 5s linear infinite;
        }

        .header-logo .logo-text {
            font-size: 18px;
        }

        /* Show logo when sidebar is collapsed */
        #sidebar.collapsed~.chat-main .header-logo {
            display: flex;
        }

        .chat-header-center {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-header-right {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 12px;
        }

        .chat-header .mobile-menu-btn {
            display: none;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            display: none;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
        }

        .status-dot.connected {
            background: var(--success-color);
            box-shadow: 0 0 8px var(--success-color);
        }

        /* Agent Type Selector */
        .agent-type-selector {
            position: relative;
        }

        .agent-type-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--dark-input);
            border: 1px solid var(--dark-border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .agent-type-button:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent);
        }

        .agent-type-button svg {
            width: 16px;
            height: 16px;
            stroke: var(--accent);
            fill: none;
            stroke-width: 2;
        }

        .agent-type-button .chevron {
            width: 14px;
            height: 14px;
            stroke: var(--text-secondary);
            transition: transform 0.2s ease;
        }

        .agent-type-button.open .chevron {
            transform: rotate(180deg);
        }

        .agent-type-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 220px;
            margin-top: 8px;
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }

        .agent-type-dropdown.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .agent-type-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .agent-type-option:first-child {
            border-radius: 12px 12px 0 0;
        }

        .agent-type-option:last-child {
            border-radius: 0 0 12px 12px;
        }

        .agent-type-option:hover {
            background: var(--bg-tertiary);
        }

        .agent-type-option.selected {
            background: rgba(99, 102, 241, 0.12);
        }

        .agent-type-option svg {
            width: 20px;
            height: 20px;
            stroke: var(--accent);
            fill: none;
            stroke-width: 2;
            flex-shrink: 0;
        }

        .agent-type-option-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .agent-type-option-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-primary);
        }

        /* Agent Info - Shows on hover of the entire option */
        .agent-type-option-desc {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.3;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .agent-type-option:hover .agent-type-option-desc {
            max-height: 40px;
            opacity: 1;
            margin-top: 2px;
        }

        .agent-type-option.selected .agent-type-option-desc {
            max-height: 40px;
            opacity: 0.8;
            margin-top: 2px;
        }

        /* Hidden info icon/container - not needed with new approach */
        .agent-info-container {
            display: none;
        }

        .agent-type-option .check-icon {
            width: 16px;
            height: 16px;
            stroke: var(--success);
            opacity: 0;
        }

        .agent-type-option.selected .check-icon {
            opacity: 1;
        }

        /* Theme Icon Buttons */
        .theme-icon-btn {
            width: 36px;
            height: 36px;
            background: var(--dark-input);
            border: 1px solid var(--dark-border);
            border-radius: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .theme-icon-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--text-secondary);
        }

        .theme-icon-btn.active {
            background: var(--dark-card);
            color: var(--text-primary);
            border-color: var(--accent);
        }

        /* Messages Container */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 24px;
        }

        .messages-container::-webkit-scrollbar {
            width: 8px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: var(--dark-border);
            border-radius: 4px;
        }

        .message {
            max-width: 900px;
            margin: 0 auto 16px;
            display: flex;
            gap: 16px;
            width: 100%;
            /* Ensure full width for alignment */
        }

        /* Avatar removed via JS, but hide in CSS just in case */
        .message-avatar {
            display: none;
        }

        .message-content {
            flex: 1;
            padding-top: 4px;
        }

        /* User Message Styling */
        .message.user {
            justify-content: flex-end;
            /* Align right */
        }

        .message.user .message-content {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            /* Align items inside right */
        }

        .message.user .message-role {
            display: none;
            /* Hide role for user */
        }

        .message.user .message-text {
            background-color: #2f2f2f;
            /* Dark bubble */
            color: #ececec;
            padding: 10px 16px;
            border-radius: 20px;
            border-bottom-right-radius: 4px;
            /* Slight indicator */
            display: inline-block;
            max-width: 85%;
            margin-left: auto;
            text-align: left;
        }

        /* User Actions (Copy/Edit) */
        .message.user .message-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 4px;
            opacity: 0;
            /* Hidden by default */
            transition: opacity 0.2s;
            border-top: none;
            padding-top: 0;
            margin-left: 0;
            pointer-events: none;
            /* Prevent clicks when invisible */
        }

        .message.user:hover .message-actions {
            opacity: 1;
            pointer-events: auto;
            /* Allow clicks when visible */
        }

        /* Assistant Message Styling */
        .message.assistant {
            justify-content: flex-start;
            /* Align left */
            min-height: 40px;
            /* Prevent collapse when loading */
        }

        .message.assistant .message-content {
            align-items: flex-start;
            /* Align items inside left */
        }

        .message.assistant .message-role {
            display: none;
            /* Hide role for assistant too, looks cleaner */
        }

        .message.assistant .message-text {
            background: transparent;
            padding: 0;
            color: var(--text-primary);
            max-width: 100%;
        }

        /* Assistant Message Actions - always visible */
        .message.assistant .message-actions {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            opacity: 1;
            pointer-events: auto;
        }

        .message.user .message-action-btn {
            width: 22px;
            height: 22px;
            font-size: 10px;
        }

        .message-action-btn {
            width: 28px;
            height: 28px;
            background: var(--dark-input);
            border: 1px solid var(--dark-border);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s;
            z-index: 10;
            /* Ensure buttons are above content */
            position: relative;
        }

        .message-action-btn:hover {
            background: var(--gradient-start);
            border-color: var(--gradient-start);
            color: white;
        }

        .message-content {
            position: relative;
            min-width: 0;
        }

        .message-edit-input {
            width: 100%;
            padding: 12px;
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 15px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
        }

        .message-edit-input:focus {
            outline: none;
            border-color: var(--text-muted);
            box-shadow: 0 0 0 4px rgba(128, 128, 128, 0.1);
        }

        .message-edit-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .message-edit-actions .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            font-family: inherit;
            border: none;
            transition: all 0.2s ease;
        }

        .btn-sm.save {
            background: var(--text-primary);
            color: var(--bg-primary);
        }

        .btn-sm.save:hover {
            opacity: 0.9;
        }

        .btn-sm.cancel {
            background: var(--card-bg);
            color: var(--text-secondary);
            border: 1px solid var(--card-border);
        }

        .btn-sm.cancel:hover {
            background: var(--bg-secondary);
        }

        .message-text {
            font-size: 15px;
            line-height: 1.7;
            color: var(--text-primary);
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-width: 0;
        }

        .message-text p {
            margin-bottom: 12px;
        }

        .message-text p:last-child {
            margin-bottom: 0;
        }

        .message-text code {
            font-family: 'JetBrains Mono', monospace;
            background: var(--dark-input);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 13px;
        }

        .message-text pre {
            background: var(--dark-input);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            padding: 16px;
            overflow-x: auto;
            margin: 12px 0;
            white-space: pre;
            word-wrap: normal;
        }

        .message-text pre code {
            background: transparent;
            padding: 0;
        }

        /* Tool Calls Container - Inline horizontal layout for concurrent tools */
        .tool-calls-container {
            display: inline-flex;
            flex-wrap: wrap;
            gap: 4px;
            align-items: center;
            margin: 2px 0;
            vertical-align: middle;
        }

        /* Text after tool calls - flows naturally */
        .message-text-after {
            display: block;
            width: 100%;
            margin-top: 6px;
            padding-top: 0;
            border-top: none;
        }

        /* Tool Call - Visible inline chips */
        .tool-call {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #f59e0b;
            border-radius: 16px;
            padding: 6px 14px;
            margin: 2px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s ease;
            max-width: fit-content;
            white-space: nowrap;
        }

        .tool-call:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #fbbf24;
        }

        /* Completed - Green */
        .tool-call.completed {
            border-color: var(--success-color);
        }

        /* Failed - Red */
        .tool-call.failed {
            border-color: var(--error-color);
        }

        .tool-call-header {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
        }



        .tool-call-name {
            color: var(--text-primary);
            font-weight: 500;
        }

        .tool-call-toggle {
            font-size: 8px;
            color: var(--text-muted);
            transition: transform 0.15s;
            margin-left: 2px;
        }

        .tool-call:not(.collapsed) .tool-call-toggle {
            transform: rotate(90deg);
        }

        /* Tool call is now a container for relative positioning */
        .tool-call {
            position: relative;
        }

        /* Expanded tool call body - dropdown style */
        .tool-call-body {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            z-index: 100;
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            padding: 10px 12px;
            width: max-content;
            max-width: min(600px, 85vw);
            max-height: 400px;
            overflow: auto;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .tool-call:not(.collapsed) .tool-call-body {
            display: block;
        }

        .tool-call-args {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 8px;
            font-family: 'JetBrains Mono', monospace;
            background: var(--dark-input);
            padding: 8px 12px;
            border-radius: 6px;
            max-height: 100px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .tool-call-section-title {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .tool-call-result {
            font-size: 13px;
            color: var(--text-primary);
            margin-top: 10px;
            font-family: 'JetBrains Mono', monospace;
            background: var(--dark-input);
            padding: 12px 16px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.5;
            border: 1px solid var(--dark-border);
        }

        .tool-call-section {
            margin-bottom: 10px;
        }

        .tool-call-section:last-child {
            margin-bottom: 0;
        }

        /* Spinner for running tools - compact */
        .tool-spinner {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 12px;
            height: 12px;
            position: relative;
            margin-left: 4px;
            color: #f59e0b;
        }

        .tool-spinner-leaf {
            position: absolute;
            width: 2px;
            height: 4px;
            background: currentColor;
            border-radius: 1px;
            left: 50%;
            top: 50%;
            transform-origin: center 0;
            opacity: 0.25;
            animation: tool-spinner-fade 0.8s linear infinite;
        }

        .tool-spinner-leaf:nth-child(1) {
            transform: translateX(-50%) rotate(0deg) translateY(-2px);
            animation-delay: 0s;
        }

        .tool-spinner-leaf:nth-child(2) {
            transform: translateX(-50%) rotate(45deg) translateY(-2px);
            animation-delay: 0.1s;
        }

        .tool-spinner-leaf:nth-child(3) {
            transform: translateX(-50%) rotate(90deg) translateY(-2px);
            animation-delay: 0.2s;
        }

        .tool-spinner-leaf:nth-child(4) {
            transform: translateX(-50%) rotate(135deg) translateY(-2px);
            animation-delay: 0.3s;
        }

        .tool-spinner-leaf:nth-child(5) {
            transform: translateX(-50%) rotate(180deg) translateY(-2px);
            animation-delay: 0.4s;
        }

        .tool-spinner-leaf:nth-child(6) {
            transform: translateX(-50%) rotate(225deg) translateY(-2px);
            animation-delay: 0.5s;
        }

        .tool-spinner-leaf:nth-child(7) {
            transform: translateX(-50%) rotate(270deg) translateY(-2px);
            animation-delay: 0.6s;
        }

        .tool-spinner-leaf:nth-child(8) {
            transform: translateX(-50%) rotate(315deg) translateY(-2px);
            animation-delay: 0.7s;
        }

        @keyframes tool-spinner-fade {

            0%,
            100% {
                opacity: 0.2;
            }

            50% {
                opacity: 1;
            }
        }

        .tool-call.completed .tool-spinner,
        .tool-call.failed .tool-spinner {
            display: none;
        }

        /* Container for multiple tool calls */
        .tool-calls-container {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin: 8px 0;
        }

        /* ===== Processing Indicator (Simple) ===== */
        .processing-indicator {
            display: inline-flex;
            align-items: center;
            padding: 4px 0;
            margin: 4px 0;
        }

        /* ===== Thinking Indicator (Gemini-style minimal) ===== */
        .thinking-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            margin: 8px 0;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }

        .thinking-indicator:hover {
            opacity: 0.8;
        }

        /* Sparkle/Star Icon */
        .thinking-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .thinking-icon-sparkle {
            width: 20px;
            height: 20px;
            background: var(--accent);
            -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M12 2L14.09 8.26L20 9.27L15.5 14.14L16.18 20.02L12 17.27L7.82 20.02L8.5 14.14L4 9.27L9.91 8.26L12 2Z'/%3E%3C/svg%3E") center/contain no-repeat;
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M12 2L14.09 8.26L20 9.27L15.5 14.14L16.18 20.02L12 17.27L7.82 20.02L8.5 14.14L4 9.27L9.91 8.26L12 2Z'/%3E%3C/svg%3E") center/contain no-repeat;
            animation: thinking-sparkle-rotate 3s linear infinite;
        }

        @keyframes thinking-sparkle-rotate {
            0% {
                transform: rotate(0deg) scale(1);
            }

            25% {
                transform: rotate(15deg) scale(1.1);
            }

            50% {
                transform: rotate(0deg) scale(1);
            }

            75% {
                transform: rotate(-15deg) scale(1.1);
            }

            100% {
                transform: rotate(0deg) scale(1);
            }
        }

        /* Processing text - simple theme-colored text */
        .processing-text {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        /* Processing dots animation */
        .processing-dots {
            display: inline-flex;
            gap: 3px;
        }

        .processing-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--text-primary);
            animation: processing-dot-pulse 1.4s ease-in-out infinite;
        }

        .processing-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .processing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .processing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes processing-dot-pulse {

            0%,
            80%,
            100% {
                opacity: 0.3;
                transform: scale(0.8);
            }

            40% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Thinking text - shimmer effect for actual thinking/reasoning mode */
        .thinking-text {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            background: linear-gradient(90deg,
                    var(--text-primary) 0%,
                    var(--accent) 50%,
                    var(--text-primary) 100%);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: thinking-shimmer 2s ease-in-out infinite;
        }

        @keyframes thinking-shimmer {
            0% {
                background-position: 100% 0;
            }

            100% {
                background-position: -100% 0;
            }
        }

        /* Bouncing dots before text (LoaderFive style) */
        .thinking-dots {
            display: flex;
            gap: 3px;
            margin-right: 4px;
        }

        .thinking-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: var(--accent);
            animation: thinking-dot-bounce 1.4s ease-in-out infinite;
        }

        .thinking-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .thinking-dot:nth-child(2) {
            animation-delay: 0.16s;
        }

        .thinking-dot:nth-child(3) {
            animation-delay: 0.32s;
        }

        @keyframes thinking-dot-bounce {

            0%,
            80%,
            100% {
                transform: scale(0.6);
                opacity: 0.5;
            }

            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Toggle Arrow */
        .thinking-toggle {
            font-size: 12px;
            color: var(--text-primary);
            transition: transform 0.2s ease;
        }

        .thinking-indicator:not(.collapsed) .thinking-toggle {
            transform: rotate(180deg);
        }

        /* Completed state - uses muted colors instead of green */
        .thinking-indicator.collapsed .thinking-icon-sparkle {
            animation: none;
        }

        .thinking-indicator.completed .thinking-icon {
            display: none;
        }

        .thinking-indicator.completed .thinking-toggle {
            display: none;
        }

        .thinking-indicator.completed .thinking-dots {
            display: none;
        }

        .thinking-indicator.completed .thinking-icon-sparkle {
            background: var(--text-muted);
            animation: none;
        }

        .thinking-indicator.completed .thinking-text {
            color: var(--text-muted);
            background: none;
            -webkit-text-fill-color: var(--text-muted);
            animation: none;
        }

        /* Legacy spinner container styles (for compatibility) */
        .spinner-container {
            display: block;
            margin: 8px 0;
        }


        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s ease-in-out infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            60%,
            100% {
                transform: translateY(0);
                opacity: 0.4;
            }

            30% {
                transform: translateY(-6px);
                opacity: 1;
            }
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 24px;
            opacity: 0.6;
        }

        .empty-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .empty-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
            max-width: 400px;
        }

        .empty-logo {
            width: 140px;
            height: auto;
            margin-bottom: 30px;
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
        }

        .empty-logo:hover {
            transform: scale(1.05);
        }

        /* User Initial Avatar */
        .user-initial {
            background: linear-gradient(135deg, var(--accent-cyan), var(--gradient-start)) !important;
            color: white;
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            box-shadow: 0 4px 10px rgba(0, 212, 255, 0.3);
        }

        /* Input Area */
        .input-area {
            padding: 20px 24px;
            border-top: 1px solid var(--dark-border);
        }

        .input-container {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
            background: var(--dark-input);
            border: 2px solid var(--dark-border);
            border-radius: 16px;
            display: flex;
            align-items: center;
            transition: all 0.3s;
            min-height: 52px;
        }

        .input-wrapper:focus-within {
            border-color: var(--gradient-start);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
        }

        #message-input {
            flex: 1;
            padding: 14px 20px 14px 8px;
            /* Reduced left padding to accommodate attach button */
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 15px;
            font-family: inherit;
            resize: none;
            max-height: 150px;
            line-height: 1.5;
            align-self: center;
        }

        #message-input:focus {
            outline: none;
        }

        #message-input::placeholder {
            color: var(--text-secondary);
        }

        .send-btn {
            width: 48px;
            height: 48px;
            background: var(--text-primary);
            border: none;
            border-radius: 12px;
            color: var(--bg-primary);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover:not(:disabled) {
            opacity: 0.9;
        }

        .send-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Image Upload Button - Now integrated into input bar */
        .attach-btn {
            width: 36px;
            height: 36px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            align-self: center;
            margin-left: 4px;
        }

        .attach-btn:hover {
            color: var(--accent-purple);
        }

        .attach-btn.has-image {
            color: var(--success-color);
        }

        /* Image Preview Container */
        .image-preview-container {
            max-width: 800px;
            margin: 0 auto 12px auto;
            padding: 0 4px;
        }

        .image-preview-wrapper {
            position: relative;
            display: inline-block;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid var(--dark-border);
            background: var(--dark-input);
        }

        .image-preview-wrapper img {
            max-width: 200px;
            max-height: 150px;
            object-fit: cover;
            display: block;
        }

        .image-preview-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255, 71, 87, 0.9);
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .image-preview-remove:hover {
            background: #ff4757;
            transform: scale(1.1);
        }

        /* Media Library styles */
        .media-library-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            border-bottom: 1px solid var(--card-border);
            background: var(--bg-secondary);
        }

        .media-library-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .media-library-title svg {
            width: 14px;
            height: 14px;
            stroke: var(--accent);
        }

        .media-header {
            margin-top: 24px;
        }

        .media-container {
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
            padding: 8px 12px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .media-item .media-delete-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 22px;
            height: 22px;
            background: rgba(239, 68, 68, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
            padding: 0;
            opacity: 0;
            transform: scale(0.8);
        }

        .media-item .media-delete-btn svg {
            width: 12px;
            height: 12px;
        }

        .media-item:hover .media-delete-btn {
            opacity: 1;
            transform: scale(1);
        }

        .media-item .media-delete-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .media-item {
            position: relative;
            background: var(--dark-item);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            aspect-ratio: 1;
        }

        .media-item:hover {
            transform: translateY(-2px);
            border-color: var(--accent-purple);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .media-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-info-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            padding: 8px 6px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .media-item:hover .media-info-overlay {
            opacity: 1;
        }

        .media-time {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.8);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .no-media-text {
            grid-column: span 2;
            text-align: center;
            color: var(--text-secondary);
            font-size: 11px;
            padding: 10px 0;
            opacity: 0.6;
        }

        /* Media View All Arrow */
        .media-view-all {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 8px 12px;
            margin: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .media-view-all:hover {
            background: var(--accent-light);
            border-color: var(--accent);
            color: var(--accent);
        }

        .media-view-all svg {
            width: 14px;
            height: 14px;
            transition: transform 0.2s;
        }

        .media-view-all:hover svg {
            transform: translateX(3px);
        }

        /* Media Gallery Modal */
        .media-gallery-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 40px;
            animation: fadeIn 0.2s ease-out;
        }

        .media-gallery-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .media-gallery-modal {
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            background: var(--bg-primary);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .media-gallery-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--card-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-secondary);
        }

        .media-gallery-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .media-gallery-title svg {
            width: 22px;
            height: 22px;
            stroke: var(--accent);
        }

        .media-gallery-close {
            width: 36px;
            height: 36px;
            background: var(--bg-tertiary);
            border: 1px solid var(--card-border);
            border-radius: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .media-gallery-close:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            color: #ef4444;
        }

        .media-gallery-close svg {
            width: 18px;
            height: 18px;
        }

        .media-gallery-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        /* Masonry Grid */
        .media-masonry {
            column-count: 4;
            column-gap: 16px;
        }

        @media (max-width: 1024px) {
            .media-masonry {
                column-count: 3;
            }
        }

        @media (max-width: 768px) {
            .media-masonry {
                column-count: 2;
            }

            .media-gallery-overlay {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .media-masonry {
                column-count: 1;
            }
        }

        /* 3D Card Effect */
        .media-3d-card {
            break-inside: avoid;
            margin-bottom: 16px;
            perspective: 1000px;
        }

        .media-3d-card-inner {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            background: var(--bg-secondary);
            border: 1px solid var(--card-border);
            transform-style: preserve-3d;
            transition: transform 0.4s ease, box-shadow 0.4s ease;
            cursor: pointer;
        }

        .media-3d-card-inner:hover {
            transform: rotateX(5deg) rotateY(-5deg) scale(1.02);
            box-shadow:
                10px 10px 30px rgba(0, 0, 0, 0.2),
                0 0 40px rgba(var(--accent-rgb, 99, 102, 241), 0.15);
        }

        .media-3d-card-inner::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg,
                    rgba(255, 255, 255, 0.1) 0%,
                    transparent 50%,
                    rgba(0, 0, 0, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 2;
            pointer-events: none;
        }

        .media-3d-card-inner:hover::before {
            opacity: 1;
        }

        .media-3d-card img {
            width: 100%;
            height: auto;
            display: block;
            transition: filter 0.4s ease;
        }

        .media-3d-card:hover img {
            filter: brightness(1.05) contrast(1.02);
        }

        .media-3d-card-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 3;
        }

        .media-3d-card-inner:hover .media-3d-card-overlay {
            transform: translateY(0);
        }

        .media-3d-card-date {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        .media-3d-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .media-3d-card-btn {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .media-3d-card-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .media-3d-card-btn.delete {
            background: rgba(239, 68, 68, 0.3);
        }

        .media-3d-card-btn.delete:hover {
            background: rgba(239, 68, 68, 0.5);
        }

        .media-3d-card-btn svg {
            width: 12px;
            height: 12px;
        }

        .media-gallery-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .media-gallery-empty svg {
            width: 60px;
            height: 60px;
            stroke: var(--text-muted);
            opacity: 0.5;
            margin-bottom: 16px;
        }

        .media-gallery-empty p {
            font-size: 14px;
        }

        .message-image {
            margin-top: 10px;
            max-width: 100%;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--dark-border);
            display: inline-block;
        }

        .message-image img {
            display: block;
            max-width: 300px;
            max-height: 400px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .message-image img:hover {
            opacity: 0.9;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                bottom: 0;
                z-index: 100;
                transition: left 0.3s;
            }

            .sidebar.open {
                left: 0;
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 99;
            }

            .sidebar-overlay.active {
                display: block;
            }

            .mobile-header {
                display: flex;
                padding: 16px;
                border-bottom: 1px solid var(--dark-border);
            }

            .menu-btn {
                padding: 8px 12px;
                background: var(--dark-input);
                border: 1px solid var(--dark-border);
                border-radius: 8px;
                color: var(--text-primary);
                font-size: 18px;
                cursor: pointer;
            }
        }

        @media (min-width: 769px) {
            .mobile-header {
                display: none;
            }
        }

        /* Tool Approval Modal */
        .approval-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .approval-modal-overlay.active {
            display: flex;
        }

        .approval-modal {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            padding: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .approval-modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .approval-modal-icon {
            width: 48px;
            height: 48px;
            background: rgba(255, 167, 38, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .approval-modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .approval-modal-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .approval-tool-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--tool-color);
            margin-bottom: 16px;
            padding: 12px 16px;
            background: rgba(255, 167, 38, 0.1);
            border-radius: 8px;
            border-left: 3px solid var(--tool-color);
        }

        .approval-args {
            background: var(--dark-input);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-word;
            color: var(--text-secondary);
        }

        /* Markdown Tables */
        table {
            border-collapse: collapse;
            width: auto;
            min-width: 200px;
            max-width: 100%;
            margin: 16px 0;
            font-size: 14px;
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            /* Use table display for proper auto-sizing */
            display: table;
        }

        th,
        td {
            border: 1px solid var(--dark-border);
            padding: 10px 16px;
            text-align: left;
            white-space: nowrap;
        }

        th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
            color: var(--accent-cyan);
        }

        tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        /* Table container scrolling for wide tables */
        .table-container {
            overflow-x: auto;
            max-width: 100%;
        }

        .message-content {
            flex: 1;
            overflow-x: auto;
            /* Allow scrolling for wide tables */
        }

        .code-block {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            margin: 10px 0;
            border: 1px solid var(--dark-border);
        }

        .approval-buttons {
            display: flex;
            gap: 12px;
        }

        .approval-btn {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .approval-btn.approve {
            background: var(--success);
            color: white;
        }

        .approval-btn.approve:hover {
            opacity: 0.9;
        }

        .approval-btn.approve:active {
            transform: scale(0.98);
        }

        .approval-btn.deny {
            background: transparent;
            border: 1.5px solid var(--card-border);
            color: var(--text-primary);
        }

        .approval-btn.deny:hover {
            background: var(--card-bg);
            border-color: var(--error);
            color: var(--error);
        }

        .approval-timeout {
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 12px;
        }

        /* ========== RESPONSIVE DESIGN ========== */

        /* Tablet: 768px to 1024px */
        @media screen and (max-width: 1024px) {
            .sidebar {
                width: 240px;
                min-width: 200px;
            }

            .chat-header {
                padding: 12px 16px;
            }

            .input-area {
                padding: 12px;
            }
        }

        /* Mobile: up to 768px */
        @media screen and (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                width: 280px;
                max-width: 85vw;
                z-index: 100;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .sidebar.collapsed {
                transform: translateX(-100%);
            }

            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 99;
                display: none;
            }

            .sidebar-overlay.active {
                display: block;
            }

            .chat-main {
                width: 100%;
                height: 100vh;
                position: relative;
                display: flex;
                flex-direction: column;
            }

            .chat-header {
                padding: 10px 12px;
            }

            #chat-title {
                font-size: 16px;
            }

            .mobile-menu-btn {
                display: flex !important;
            }

            .messages-container {
                padding: 12px;
            }

            .message {
                max-width: 98%;
                gap: 8px;
            }

            .message-avatar {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }

            .assistant-avatar-img {
                width: 32px;
                height: 32px;
            }

            .input-area {
                padding: 8px 12px;
            }

            .input-container {
                gap: 8px;
            }

            #message-input {
                font-size: 14px;
                padding: 10px 12px;
                min-height: 40px;
            }

            #send-btn {
                width: 40px;
                height: 40px;
            }

            .code-block-header {
                padding: 6px 10px;
            }

            .table-header {
                padding: 6px 10px;
            }

            .table-container table {
                font-size: 12px;
            }

            th,
            td {
                padding: 6px 10px;
            }

            .tool-call {
                margin: 8px 0;
            }

            .approval-modal {
                width: 95%;
                padding: 16px;
            }
        }

        /* Extra small mobile: up to 480px */
        @media screen and (max-width: 480px) {
            .sidebar {
                width: 100%;
                max-width: 100%;
            }

            .message-content {
                max-width: calc(100vw - 70px);
            }

            .empty-state h2 {
                font-size: 20px;
            }

            .empty-state p {
                font-size: 13px;
            }

            .logo-img {
                height: 60px;
            }
        }

        /* Mobile menu button - hidden by default, shown on mobile */
        .mobile-menu-btn {
            display: none;
            background: transparent;
            border: 1px solid var(--dark-border);
            color: var(--text-secondary);
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            margin-right: 8px;
        }

        .mobile-menu-btn:hover {
            background: var(--dark-input);
            color: var(--accent-cyan);
        }

        /* Theme Toggle Button - matching common.css/landing.css */
        .theme-toggle-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--card-bg);
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
        }

        .theme-toggle-btn:hover {
            background: var(--bg-secondary);
        }

        .theme-toggle-btn svg {
            color: var(--text-primary);
            fill: var(--text-primary);
        }

        .theme-toggle-btn .sun-icon {
            display: block;
        }

        .theme-toggle-btn .moon-icon {
            display: none;
        }

        [data-theme="dark"] .theme-toggle-btn .sun-icon {
            display: none;
        }

        [data-theme="dark"] .theme-toggle-btn .moon-icon {
            display: block !important;
        }

        /* Empty State Logo */
        .empty-logo-icon {
            width: 80px;
            height: 80px;
            fill: var(--text-primary);
            opacity: 0.1;
            margin-bottom: 24px;
        }

        /* Clock Widget */
        .clock-widget {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 24px;
        }

        .clock-greeting {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .clock-row {
            display: flex;
            gap: 48px;
            align-items: center;
        }

        .clock-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 32px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            min-width: 160px;
        }

        .clock-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .clock-time {
            font-size: 40px;
            font-weight: 700;
            letter-spacing: -0.02em;
            color: var(--text-primary);
            line-height: 1;
            font-variant-numeric: tabular-nums;
        }

        .clock-date {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-muted);
        }

        @media (max-width: 640px) {
            .clock-row {
                flex-direction: column;
                gap: 16px;
            }

            .clock-card {
                min-width: 140px;
                padding: 16px 24px;
            }

            .clock-time {
                font-size: 32px;
            }
        }

        /* Responsive / Mobile Styles */
        .mobile-menu-btn {
            display: none;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            margin-right: 16px;
            padding: 4px;
            border-radius: 4px;
        }

        .mobile-menu-btn:hover {
            background-color: var(--dark-input);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 99;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(2px);
        }

        .sidebar-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        @media screen and (max-width: 768px) {
            .mobile-menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 8px;
            }

            .mobile-menu-btn svg {
                width: 24px;
                height: 24px;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                z-index: 100;
                transform: translateX(-100%);
                width: 280px !important;
                /* Force width */
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-resizer {
                display: none;
            }

            /* Hide desktop toggle area on mobile - Aggressive override */
            .sidebar-toggle-area,
            .sidebar.collapsed+.chat-main .sidebar-toggle-area {
                display: none !important;
                visibility: hidden !important;
                pointer-events: none !important;
            }

            .chat-main {
                width: 100%;
            }

            .chat-header {
                padding: 12px 16px;
            }

            /* Fix message widths on mobile */
            .message {
                max-width: 100%;
                margin-bottom: 12px;
                gap: 10px;
            }

            .message.user .message-text {
                max-width: 90%;
            }

            .messages-container {
                padding: 16px;
            }

            .input-area {
                padding: 12px 16px;
            }

            /* Modal adjustments */
            .search-modal {
                width: 90%;
                max-height: 70vh;
            }

            /* Clock adjustments */
            .clock-greeting {
                font-size: 24px;
            }

            .clock-time {
                font-size: 28px;
            }

            .clock-card {
                padding: 12px 20px;
                min-width: 120px;
            }
        }

        /* ===== MCP Configuration Styles ===== */

        /* MCP Config Button in Header */
        .mcp-config-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--card-bg);
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
            position: relative;
        }

        .mcp-config-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
        }

        .mcp-config-btn svg {
            width: 18px;
            height: 18px;
            stroke: var(--text-primary);
            fill: none;
        }

        .mcp-config-btn .mcp-status-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid var(--bg-primary);
        }

        .mcp-config-btn .mcp-status-badge.connected {
            background: #22c55e;
            box-shadow: 0 0 6px rgba(34, 197, 94, 0.5);
        }

        .mcp-config-btn .mcp-status-badge.connecting {
            background: #f59e0b;
            animation: mcp-pulse 1.5s ease-in-out infinite;
        }

        .mcp-config-btn .mcp-status-badge.disconnected {
            background: #ef4444;
        }

        .mcp-config-btn .mcp-status-badge.none {
            display: none;
        }

        @keyframes mcp-pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* MCP Status Button in Input Area */
        .mcp-status-btn {
            width: 36px;
            height: 36px;
            background: transparent;
            border: 1px solid var(--card-border);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            margin-bottom: 6px;
            position: relative;
        }

        .mcp-status-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
        }

        .mcp-status-btn svg {
            width: 16px;
            height: 16px;
            stroke: var(--text-secondary);
            fill: none;
        }

        .mcp-status-btn:hover svg {
            stroke: var(--accent);
        }

        /* MCP Modal Overlay */
        .mcp-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding-top: 5vh;
            z-index: 10001;
            animation: fadeIn 0.2s ease-out;
        }

        .mcp-modal-overlay.active {
            display: flex;
        }

        /* MCP Modal */
        .mcp-modal {
            background: var(--bg-primary);
            width: 720px;
            max-width: 95vw;
            max-height: 85vh;
            border-radius: 20px;
            border: 1px solid var(--card-border);
            box-shadow: 0 25px 60px -12px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: slideDown 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .mcp-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--card-border);
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .mcp-modal-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .mcp-modal-title svg {
            width: 24px;
            height: 24px;
            stroke: var(--accent);
            fill: none;
        }

        .mcp-modal-title h2 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .mcp-modal-close {
            width: 36px;
            height: 36px;
            background: transparent;
            border: 1px solid var(--card-border);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            color: var(--text-secondary);
            font-size: 20px;
        }

        .mcp-modal-close:hover {
            background: var(--error);
            border-color: var(--error);
            color: white;
        }

        .mcp-modal-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* JSON Editor Section */
        .mcp-json-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .mcp-json-section label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mcp-json-section label svg {
            width: 16px;
            height: 16px;
            stroke: var(--accent);
        }

        .mcp-json-editor {
            width: 100%;
            min-height: 280px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            padding: 16px;
            border: 1px solid var(--card-border);
            border-radius: 12px;
            background: var(--input-bg);
            color: var(--text-primary);
            resize: vertical;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .mcp-json-editor:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        .mcp-json-editor.error {
            border-color: var(--error);
        }

        .mcp-json-error {
            font-size: 12px;
            color: var(--error);
            padding: 8px 12px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 8px;
            display: none;
        }

        .mcp-json-error.visible {
            display: block;
        }

        /* MCP Servers Status List */
        .mcp-servers-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .mcp-servers-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .mcp-servers-header h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }

        .mcp-servers-header h3 svg {
            width: 16px;
            height: 16px;
            stroke: var(--accent);
        }

        .mcp-refresh-btn {
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            background: var(--bg-secondary);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mcp-refresh-btn:hover {
            background: var(--input-bg);
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .mcp-refresh-btn svg {
            width: 14px;
            height: 14px;
        }

        .mcp-servers-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .mcp-server-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--card-border);
            border-radius: 10px;
            transition: all 0.2s;
        }

        .mcp-server-item:hover {
            border-color: var(--accent);
        }

        .mcp-server-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .mcp-server-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .mcp-server-status.connected {
            background: #22c55e;
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
        }

        .mcp-server-status.connecting {
            background: #f59e0b;
            animation: mcp-pulse 1.5s ease-in-out infinite;
        }

        .mcp-server-status.disconnected {
            background: #ef4444;
        }

        .mcp-server-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .mcp-server-type {
            font-size: 12px;
            color: var(--text-muted);
            padding: 2px 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .mcp-no-servers {
            text-align: center;
            padding: 24px;
            color: var(--text-muted);
            font-size: 13px;
        }

        /* MCP Modal Footer */
        .mcp-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--card-border);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 12px;
            background: var(--bg-secondary);
        }

        .mcp-modal-btn {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .mcp-modal-btn.cancel {
            background: transparent;
            border: 1px solid var(--card-border);
            color: var(--text-secondary);
        }

        .mcp-modal-btn.cancel:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .mcp-modal-btn.save {
            background: var(--accent);
            border: none;
            color: white;
        }

        .mcp-modal-btn.save:hover {
            opacity: 0.9;
        }

        .mcp-modal-btn.save:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* MCP Status Popup (from input area button) */
        .mcp-status-popup {
            position: absolute;
            bottom: 100%;
            left: 0;
            margin-bottom: 8px;
            width: 320px;
            background: var(--bg-primary);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 100;
            overflow: hidden;
        }

        .mcp-status-popup.active {
            display: block;
            animation: slideUp 0.2s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .mcp-status-popup-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--card-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-secondary);
        }

        .mcp-status-popup-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .mcp-status-popup-config {
            font-size: 11px;
            color: var(--accent);
            cursor: pointer;
            text-decoration: none;
        }

        .mcp-status-popup-config:hover {
            text-decoration: underline;
        }

        .mcp-status-popup-content {
            max-height: 200px;
            overflow-y: auto;
            padding: 8px;
        }

        .mcp-status-popup-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background 0.15s;
        }

        .mcp-status-popup-item:hover {
            background: var(--bg-secondary);
        }

        .mcp-status-popup-name {
            flex: 1;
            font-size: 13px;
            color: var(--text-primary);
        }

        .mcp-status-popup-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .mcp-status-popup-badge.connected {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }

        .mcp-status-popup-badge.connecting {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }

        .mcp-status-popup-badge.disconnected {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .mcp-status-popup-empty {
            padding: 20px;
            text-align: center;
            color: var(--text-muted);
            font-size: 12px;
        }

        /* Responsive */
        @media screen and (max-width: 768px) {
            .mcp-modal {
                width: 95%;
                max-height: 90vh;
                margin-top: 2vh;
            }

            .mcp-json-editor {
                min-height: 200px;
            }

            .mcp-status-popup {
                width: 280px;
            }
        }

        /* ===== Tools Button & Popup (Inside Input Bar) ===== */
        .tools-btn-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-left: 10px;
            align-self: center;
        }

        .tools-btn {
            width: 36px;
            height: 36px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }

        .tools-btn:hover {
            background: var(--bg-tertiary);
            color: var(--accent);
        }

        .tools-btn.active {
            background: var(--accent-light);
            color: var(--accent);
        }

        .tools-btn svg {
            transition: transform 0.2s ease;
        }

        .tools-btn.active svg {
            transform: rotate(45deg);
        }

        /* Tools Popup */
        .tools-popup {
            position: absolute;
            bottom: 100%;
            left: 0;
            margin-bottom: 12px;
            width: 340px;
            max-height: 400px;
            background: var(--bg-primary);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 200;
            overflow: hidden;
            animation: slideUpTools 0.2s ease-out;
        }

        .tools-popup.active {
            display: block;
        }

        @keyframes slideUpTools {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tools-popup-header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--card-border);
            display: none;
            /* Hide the old header */
            align-items: center;
            justify-content: space-between;
            background: var(--bg-secondary);
        }

        .tools-popup-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .tools-popup-close {
            width: 24px;
            height: 24px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .tools-popup-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .tools-popup-content {
            max-height: 400px;
            overflow-y: auto;
            padding: 8px;
        }

        /* Tools Section Groups (Expandable) */
        .tools-section-group {
            margin-bottom: 4px;
            border: 1px solid var(--card-border);
            border-radius: 10px;
            overflow: hidden;
        }

        .tools-section-group:last-child {
            margin-bottom: 0;
        }

        .tools-section-header-expandable {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            cursor: pointer;
            background: var(--bg-secondary);
            transition: all 0.15s;
            user-select: none;
        }

        .tools-section-header-expandable:hover {
            background: var(--bg-tertiary);
        }

        .tools-section-static-header {
            padding: 12px 16px 8px 16px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .upload-media-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            margin: 0 8px 8px 8px;
            border-radius: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--card-border);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upload-media-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        .upload-media-item-info {
            flex: 1;
        }

        .upload-media-item-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .upload-media-item-desc {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .tools-popup-content {
            max-height: 480px;
            overflow-y: auto;
            padding: 8px 0;
        }

        .tools-section-group.expanded .tools-section-header-expandable {
            border-bottom: 1px solid var(--card-border);
        }

        .tools-section-header-expandable svg:first-child {
            stroke: var(--text-muted);
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }

        .tools-section-title {
            flex: 1;
        }

        .tools-section-count {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            background: var(--bg-tertiary);
            padding: 2px 8px;
            border-radius: 10px;
            text-transform: none;
        }

        .tools-section-expand-icon {
            width: 14px;
            height: 14px;
            stroke: var(--text-muted);
            transition: transform 0.2s ease;
            flex-shrink: 0;
        }

        .tools-section-group.expanded .tools-section-expand-icon {
            transform: rotate(180deg);
        }

        .tools-section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.25s ease-out;
        }

        .tools-section-group.expanded .tools-section-content {
            max-height: 1500px;
            transition: max-height 0.35s ease-in;
        }

        .tools-section-content .tools-list {
            padding: 4px 0;
        }

        /* Legacy section styles (keep for backwards compatibility) */
        .tools-section {
            margin-bottom: 8px;
        }

        .tools-section:last-child {
            margin-bottom: 0;
        }

        .tools-section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .tools-section-header svg {
            stroke: var(--text-muted);
        }

        .tools-configure-link {
            font-size: 11px;
            font-weight: 500;
            color: var(--accent);
            cursor: pointer;
            text-transform: none;
            letter-spacing: 0;
        }

        .tools-configure-link:hover {
            text-decoration: underline;
        }

        .tools-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .tools-loading,
        .tools-empty {
            padding: 16px;
            text-align: center;
            color: var(--text-muted);
        }

        /* Global Disabled State for Tools Popup */
        .tools-toggle-wrapper {
            display: flex;
            align-items: center;
            margin-left: 8px;
            margin-right: 4px;
        }

        .tools-switch {
            position: relative;
            display: inline-block;
            width: 28px;
            height: 16px;
        }

        .tools-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .tools-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-tertiary);
            transition: .3s;
            border-radius: 18px;
            border: 1px solid var(--card-border);
        }

        .tools-slider:before {
            position: absolute;
            content: "";
            height: 12px;
            width: 12px;
            left: 2px;
            bottom: 2px;
            background-color: var(--text-muted);
            transition: .3s;
            border-radius: 50%;
        }

        .tools-switch input:checked+.tools-slider {
            background-color: rgba(46, 204, 113, 0.2);
            border-color: #2ecc71;
        }

        .tools-switch input:checked+.tools-slider:before {
            transform: translateX(14px);
            background-color: #2ecc71;
        }

        .tools-popup.global-disabled .tools-list,
        .tools-popup.global-disabled .mcp-server-group-header .tools-switch,
        .tools-popup.global-disabled .tool-item .tool-toggle {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(100%);
        }

        /* Tool Item */
        .tools-toggle-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
            margin-right: 8px;
        }

        .tools-switch {
            position: relative;
            display: inline-block;
            width: 32px;
            height: 18px;
        }

        .tools-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        /* Tooltip style for header buttons */
        .tooltip-container {
            position: relative;
        }

        .tooltip-text {
            visibility: hidden;
            width: auto;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 1001;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s, visibility 0.2s;
            font-size: 11px;
            white-space: nowrap;
            border: 1px solid var(--card-border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            pointer-events: none;
            text-transform: none;
            font-weight: 500;
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Tools Popup Granular Control Styles */
        .tools-popup.global-disabled .tools-section-group:not(#mcp-tools-group),
        .tools-popup.global-disabled .upload-media-item {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(1);
        }

        .tools-popup.global-disabled #mcp-tools-group .tools-list,
        .tools-popup.global-disabled #mcp-tools-group .mcp-server-group {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(1);
        }

        .tools-popup.global-disabled #global-tools-toggle {
            pointer-events: auto;
        }

        .tools-section-group.disabled-section .tools-list {
            opacity: 0.5;
            pointer-events: none;
        }

        .mcp-server-group.disabled-server .mcp-server-tools {
            opacity: 0.5;
            pointer-events: none;
        }

        /* Tool Item */
        .tool-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 10px;
            transition: background 0.15s;
        }

        .tool-item:hover {
            background: var(--bg-secondary);
        }

        .tool-item-icon {
            width: 28px;
            height: 28px;
            background: var(--accent-light);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .tool-item-icon svg {
            width: 14px;
            height: 14px;
            stroke: var(--accent);
        }

        .tool-item-icon.mcp {
            background: rgba(139, 92, 246, 0.15);
        }

        .tool-item-icon.mcp svg {
            stroke: #8b5cf6;
        }

        .tool-item-info {
            flex: 1;
            min-width: 0;
        }

        .tool-item-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tool-item-desc {
            font-size: 11px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 2px;
        }

        .tool-item-source {
            font-size: 10px;
            color: var(--text-muted);
            padding: 2px 6px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            margin-left: 6px;
        }

        /* Toggle Switch */
        .tool-toggle {
            position: relative;
            width: 36px;
            height: 20px;
            flex-shrink: 0;
        }

        .tool-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .tool-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--card-border);
            transition: 0.2s;
            border-radius: 20px;
        }

        .tool-toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 2px;
            bottom: 2px;
            background-color: var(--text-muted);
            transition: 0.2s;
            border-radius: 50%;
        }

        .tool-toggle input:checked+.tool-toggle-slider {
            background-color: var(--accent);
            border-color: var(--accent);
        }

        .tool-toggle input:checked+.tool-toggle-slider:before {
            background-color: white;
            transform: translateX(16px);
        }

        .tool-item.disabled .tool-item-name,
        .tool-item.disabled .tool-item-desc {
            opacity: 0.5;
        }

        /* MCP Server Group in Tools - Accordion Style */
        .mcp-server-group {
            margin-bottom: 4px;
            border: 1px solid var(--card-border);
            border-radius: 10px;
            overflow: hidden;
        }

        .mcp-server-group-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            background: var(--bg-secondary);
            transition: all 0.15s;
            user-select: none;
        }

        .mcp-server-group-header:hover {
            background: var(--bg-tertiary);
        }

        .mcp-server-group.expanded .mcp-server-group-header {
            border-bottom: 1px solid var(--card-border);
        }

        .mcp-server-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
            flex-shrink: 0;
        }

        .mcp-server-status.disconnected {
            background: #ef4444;
        }

        .mcp-server-name {
            flex: 1;
            font-weight: 500;
        }

        .mcp-server-tools-count {
            font-size: 11px;
            color: var(--text-muted);
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .mcp-server-expand-icon {
            width: 16px;
            height: 16px;
            stroke: var(--text-muted);
            transition: transform 0.2s ease;
            flex-shrink: 0;
        }

        .mcp-server-group.expanded .mcp-server-expand-icon {
            transform: rotate(180deg);
        }

        .mcp-server-tools {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.25s ease-out;
        }

        .mcp-server-group.expanded .mcp-server-tools {
            max-height: 1000px;
            transition: max-height 0.35s ease-in;
        }

        .mcp-server-tools .tools-list {
            padding: 4px 0;
        }

        .mcp-server-toggle {
            margin-left: 4px;
        }

        /* Responsive */
        @media screen and (max-width: 768px) {
            .tools-popup {
                width: 300px;
                left: -10px;
            }
        }

        @media screen and (max-width: 480px) {
            .tools-popup {
                position: fixed;
                left: 16px;
                right: 16px;
                bottom: 80px;
                width: auto;
                max-height: 60vh;
            }
        }

        /* Multiple Image Previews above Input */
        .images-preview-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding: 8px 16px;
            margin-bottom: 8px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            min-height: 0;
        }

        /* Ensure the container is visible/hidden appropriately */
        .images-preview-wrapper:empty {
            display: none;
        }

        .image-preview-item {
            position: relative;
            width: 64px;
            height: 64px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--dark-border);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
            background: var(--dark-card);
        }

        .image-preview-item:hover {
            transform: scale(1.05);
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-remove {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 18px;
            height: 18px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 50%;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            border: none;
            transition: background 0.2s;
            padding: 0;
            line-height: 1;
        }

        .image-preview-remove:hover {
            background: #ef4444;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar Overlay (mobile) -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-header-wrapper">
                    <div class="logo">
                        <div class="logo-icon">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
                            </svg>
                        </div>
                        <span class="logo-text shiny-text">Agentry</span>
                    </div>
                    <button class="sidebar-header-toggle" id="sidebar-collapse-btn" title="Collapse Sidebar">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 17l-5-5 5-5" />
                            <path d="M18 17l-5-5 5-5" />
                        </svg>
                    </button>
                </div>
                <!-- Action Buttons: New Chat & Search -->
                <div class="sidebar-actions-row">
                    <button class="sidebar-action-btn" id="new-chat-btn" title="New Chat">
                        <div class="btn-icon-wrapper">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" width="16" height="16">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </div>
                        <span>New chat</span>
                    </button>
                    <button class="sidebar-action-btn" id="search-toggle-btn" title="Search chats">
                        <div class="btn-icon-wrapper">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" width="16" height="16">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                        </div>
                        <span>Search chats</span>
                    </button>
                    <button class="sidebar-action-btn" id="media-library-toggle" title="Media Library">
                        <div class="btn-icon-wrapper">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" width="16" height="16">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                        </div>
                        <span>Media</span>
                    </button>
                </div>
            </div>

            <!-- Media Library Section -->
            <div class="media-library-wrapper" id="media-library-wrapper"
                style="display: none; border-bottom: 1px solid var(--card-border);">
                <div class="media-library-header">
                    <div class="media-library-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                        <span>Recent Media</span>
                    </div>
                </div>
                <div class="media-container" id="media-container" style="max-height: 180px;">
                    <!-- Recent media files will be loaded here (limited to 4) -->
                    <div class="no-media-text">No media uploaded yet</div>
                </div>
                <!-- View All Button -->
                <button class="media-view-all" id="media-view-all-btn" title="View all media">
                    <span>View All Media</span>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                        <polyline points="12 5 19 12 12 19"></polyline>
                    </svg>
                </button>
            </div>

            <!-- Resizer -->
            <div class="sidebar-resizer" id="sidebar-resizer"></div>

            <!-- Your chats section header -->
            <div class="sessions-header">
                <span>Your chats</span>
            </div>

            <div class="sessions-container" id="sessions-container">
                <!-- Sessions will be loaded here -->
            </div>

            <!-- End of Sessions -->

            <div class="sidebar-footer">
                <div class="provider-info" id="provider-info" onclick="window.location.href='/setup'">
                    <div class="provider-icon-small" id="provider-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="18" height="18">
                            <rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect>
                            <rect x="9" y="9" width="6" height="6"></rect>
                            <line x1="9" y1="1" x2="9" y2="4"></line>
                            <line x1="15" y1="1" x2="15" y2="4"></line>
                            <line x1="9" y1="20" x2="9" y2="23"></line>
                            <line x1="15" y1="20" x2="15" y2="23"></line>
                            <line x1="20" y1="9" x2="23" y2="9"></line>
                            <line x1="20" y1="14" x2="23" y2="14"></line>
                            <line x1="1" y1="9" x2="4" y2="9"></line>
                            <line x1="1" y1="14" x2="4" y2="14"></line>
                        </svg>
                    </div>
                    <div class="provider-details">
                        <div class="provider-name-small" id="provider-name">Loading...</div>
                        <div class="model-info-row">
                            <div class="model-name-small" id="model-name">-</div>
                            <div class="capabilities-info-btn" id="capabilities-info-btn"
                                onclick="event.stopPropagation();">
                                <span></span>
                                <div class="capabilities-tooltip" id="capabilities-tooltip">
                                    <div class="capabilities-tooltip-title">Model Capabilities</div>
                                    <ul class="capabilities-list" id="capabilities-list">
                                        <li class="capability-item not-supported" id="cap-tools">Tools</li>
                                        <li class="capability-item not-supported" id="cap-vision">Vision</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <span class="change-btn">Change</span>
                </div>

                <div class="user-menu">
                    <div class="user-avatar" id="user-avatar"></div>
                    <span class="user-name" id="user-name">Loading...</span>
                    <button class="logout-btn" id="logout-btn">Logout</button>
                </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="chat-main">
            <!-- Mobile Header -->
            <div class="mobile-header">
                <button class="menu-btn" id="menu-btn"></button>
            </div>

            <!-- Sidebar Toggle (Visible when collapsed) -->
            <div class="sidebar-toggle-area">
                <button class="sidebar-toggle-btn" id="sidebar-expand-btn" title="Expand Sidebar">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M13 17l5-5-5-5" />
                        <path d="M6 17l5-5-5-5" />
                    </svg>
                </button>
            </div>

            <div class="chat-header">
                <!-- Left side (empty for now, keeps grid balanced) -->
                <div class="chat-header-left">
                    <a href="/" class="header-logo">
                        <div class="logo-icon">
                            <svg viewBox="0 0 24 24">
                                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                            </svg>
                        </div>
                        <span class="logo-text shiny-text">Agentry</span>
                    </a>
                </div>

                <!-- Center - Agent Type Selector -->
                <div class="chat-header-center">
                    <div class="agent-type-selector" id="agent-type-selector">
                        <button class="agent-type-button" id="agent-type-button" title="Change Agent Type">
                            <svg viewBox="0 0 24 24" class="agent-icon-current" id="agent-icon-current">
                                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
                            </svg>
                            <span id="agent-type-label">Default Agent</span>
                            <svg viewBox="0 0 24 24" class="chevron">
                                <polyline points="6 9 12 15 18 9" />
                            </svg>
                        </button>
                        <div class="agent-type-dropdown" id="agent-type-dropdown">
                            <div class="agent-type-option" data-agent="default">
                                <svg viewBox="0 0 24 24">
                                    <path d="M12 2L2 7l10 5 10-5-10-5z" />
                                    <path d="M2 17l10 5 10-5" />
                                    <path d="M2 12l10 5 10-5" />
                                </svg>
                                <div class="agent-type-option-info">
                                    <div class="agent-type-option-name">Default Agent</div>
                                    <div class="agent-type-option-desc">All tools + MCP servers for complex workflows
                                    </div>
                                </div>
                                <svg viewBox="0 0 24 24" class="check-icon">
                                    <polyline points="20 6 9 17 4 12" />
                                </svg>
                            </div>
                            <div class="agent-type-option" data-agent="copilot">
                                <svg viewBox="0 0 24 24">
                                    <polyline points="16 18 22 12 16 6" />
                                    <polyline points="8 6 2 12 8 18" />
                                </svg>
                                <div class="agent-type-option-info">
                                    <div class="agent-type-option-name">Copilot Agent</div>
                                    <div class="agent-type-option-desc">Coding focused with file & execution tools</div>
                                </div>
                                <svg viewBox="0 0 24 24" class="check-icon">
                                    <polyline points="20 6 9 17 4 12" />
                                </svg>
                            </div>
                            <div class="agent-type-option" data-agent="smart">
                                <svg viewBox="0 0 24 24">
                                    <path d="M9 18h6" />
                                    <path d="M10 22h4" />
                                    <path
                                        d="M12 2a7 7 0 017 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 01-1 1H9a1 1 0 01-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 017-7z" />
                                </svg>
                                <div class="agent-type-option-info">
                                    <div class="agent-type-option-name">Smart Agent</div>
                                    <div class="agent-type-option-desc">Enhanced reasoning & project context</div>
                                </div>
                                <svg viewBox="0 0 24 24" class="check-icon">
                                    <polyline points="20 6 9 17 4 12" />
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right side controls -->
                <div class="chat-header-right">
                    <!-- MCP Config Button (only visible for Default Agent) -->
                    <button id="mcp-config-btn" class="mcp-config-btn tooltip-container">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path
                                d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83" />
                            <circle cx="12" cy="12" r="3" />
                        </svg>
                        <span id="mcp-header-status" class="mcp-status-badge none"></span>
                        <span class="tooltip-text">MCP Server Configuration</span>
                    </button>
                    <!-- Theme Toggle Button -->
                    <button id="theme-toggle-btn" class="theme-toggle-btn" title="Toggle theme">
                        <!-- Sun icon -->
                        <svg class="sun-icon" viewBox="0 0 24 24" width="20" height="20" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                        <!-- Moon icon -->
                        <svg class="moon-icon" viewBox="0 0 24 24" width="20" height="20" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                    </button>
                    <!-- Connection Status -->
                    <div class="connection-status">
                        <div class="status-dot" id="status-dot"></div>
                        <span id="status-text">Connecting...</span>
                    </div>
                </div>
            </div>

            <div class="messages-container" id="messages-container">
                <div class="empty-state" id="empty-state">
                    <div class="clock-widget" id="clock-widget">
                        <div class="clock-greeting" id="clock-greeting">Good Evening</div>
                        <div class="clock-row">
                            <div class="clock-card">
                                <div class="clock-label">India (IST)</div>
                                <div class="clock-time" id="clock-time-india">00:00</div>
                            </div>
                            <div class="clock-card">
                                <div class="clock-label">California (PST)</div>
                                <div class="clock-time" id="clock-time-usa">00:00</div>
                            </div>
                        </div>
                        <div class="clock-date" id="clock-date">Wednesday, December 17</div>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <!-- Image Preview Area (hidden by default) -->
                <div class="images-preview-wrapper" id="images-preview-wrapper" style="display: none;"></div>
                <div class="input-container">
                    <input type="file" id="image-input" accept="image/*" multiple style="display: none;">
                    <div class="input-wrapper">
                        <!-- Tools Button (+ button) - Inside the input bar -->
                        <div class="tools-btn-container" id="tools-btn-container">
                            <button class="tools-btn" id="tools-btn" title="Available Tools">
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                            </button>
                            <!-- Tools Popup -->
                            <div class="tools-popup" id="tools-popup">
                                <div class="tools-popup-header">
                                    <span class="tools-popup-title">Available Tools</span>
                                    <button class="tools-popup-close" id="tools-popup-close"></button>
                                </div>
                                <div class="tools-popup-content" id="tools-popup-content">
                                    <!-- Media Section -->
                                    <div class="tools-section-static-header">Upload Media</div>
                                    <div class="upload-media-item" id="merged-upload-btn">
                                        <div class="tool-item-icon">
                                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none"
                                                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                stroke-linejoin="round">
                                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                                <polyline points="21 15 16 10 5 21"></polyline>
                                            </svg>
                                        </div>
                                        <div class="upload-media-item-info">
                                            <div class="upload-media-item-name">Attach Images</div>
                                            <div class="upload-media-item-desc">Upload photos from your device</div>
                                        </div>
                                    </div>

                                    <!-- Tools Section -->
                                    <div class="tools-section-static-header">
                                        <span>tools</span>
                                        <span class="tools-section-count" id="total-tools-count">0</span>
                                    </div>

                                    <!-- Built-in Tools Section (Collapsible) -->
                                    <div class="tools-section-group" id="builtin-tools-group">
                                        <div class="tools-section-header-expandable"
                                            onclick="toggleToolsSectionExpand('builtin-tools-group')">
                                            <svg viewBox="0 0 24 24" width="14" height="14" fill="none"
                                                stroke="currentColor" stroke-width="2">
                                                <path
                                                    d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z">
                                                </path>
                                            </svg>
                                            <span class="tools-section-title">Built-in Tools</span>
                                            <span class="tools-section-count" id="builtin-tools-count">0</span>
                                            <div class="tools-toggle-wrapper" onclick="event.stopPropagation()">
                                                <label class="tools-switch">
                                                    <input type="checkbox" id="builtin-tools-toggle" checked>
                                                    <span class="tools-slider"></span>
                                                </label>
                                            </div>
                                            <svg class="tools-section-expand-icon" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                stroke-linejoin="round">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                        <div class="tools-section-content">
                                            <div class="tools-list" id="builtin-tools-list">
                                                <div class="tools-loading">Loading tools...</div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- MCP Tools Section (Collapsible) -->
                                    <div class="tools-section-group" id="mcp-tools-group">
                                        <div class="tools-section-header-expandable"
                                            onclick="toggleToolsSectionExpand('mcp-tools-group')">
                                            <svg viewBox="0 0 24 24" width="14" height="14" fill="none"
                                                stroke="currentColor" stroke-width="2">
                                                <path
                                                    d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83">
                                                </path>
                                                <circle cx="12" cy="12" r="3"></circle>
                                            </svg>
                                            <span class="tools-section-title">MCP Tools</span>
                                            <span class="tools-section-count" id="mcp-tools-count">0</span>
                                            <div class="tools-toggle-wrapper" onclick="event.stopPropagation()">
                                                <label class="tools-switch">
                                                    <input type="checkbox" id="mcp-section-toggle" checked>
                                                    <span class="tools-slider"></span>
                                                </label>
                                            </div>
                                            <svg class="tools-section-expand-icon" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                stroke-linejoin="round">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                        <div class="tools-section-content">
                                            <div class="tools-list" id="mcp-tools-list">
                                                <div class="tools-empty">No MCP servers configured</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Image Upload Button (hidden by default, shown when vision is supported) -->
                        <button class="attach-btn" id="attach-image-btn" title="Attach image">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                        </button>
                        <textarea id="message-input" placeholder="Type your message or attach an image..."
                            rows="1"></textarea>
                    </div>
                    <button class="send-btn" id="send-btn" disabled></button>
                </div>
            </div>
            <!-- Scroll to bottom button -->
            <button id="scroll-bottom-btn" class="scroll-bottom-btn" title="Scroll to bottom">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"
                    stroke-linejoin="round">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </button>
        </main>
    </div>

    <!-- Tool Approval Modal -->
    <div class="approval-modal-overlay" id="approval-modal-overlay">
        <div class="approval-modal">
            <div class="approval-modal-header">
                <div class="approval-modal-icon"></div>
                <div>
                    <div class="approval-modal-title">Tool Approval Required</div>
                    <div class="approval-modal-subtitle">The agent wants to run a tool that requires your permission
                    </div>
                </div>
            </div>
            <div class="approval-tool-name" id="approval-tool-name">Tool Name</div>
            <div class="approval-args" id="approval-args">{}</div>
            <div class="approval-buttons">
                <button class="approval-btn deny" id="approval-deny-btn"> Deny</button>
                <button class="approval-btn approve" id="approval-approve-btn"> Approve</button>
            </div>
            <div class="approval-timeout" id="approval-timeout">Auto-deny in 120s</div>
        </div>
    </div>

    <!-- Search Modal -->
    <div class="search-modal-overlay" id="search-modal-overlay">
        <div class="search-modal">
            <div class="search-modal-header">
                <div class="modal-search-wrapper">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" id="modal-search-input" class="modal-search-input"
                        placeholder="Search your chats..." autocomplete="off">
                </div>
            </div>
            <div class="search-modal-content">
                <div class="modal-sessions-list" id="modal-sessions-list">
                    <!-- Results will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- MCP Configuration Modal -->
    <div class="mcp-modal-overlay" id="mcp-modal-overlay">
        <div class="mcp-modal">
            <div class="mcp-modal-header">
                <div class="mcp-modal-title">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83" />
                        <circle cx="12" cy="12" r="3" />
                    </svg>
                    <h2>MCP Server Configuration</h2>
                </div>
                <button class="mcp-modal-close" id="mcp-modal-close" title="Close"></button>
            </div>
            <div class="mcp-modal-content">
                <!-- JSON Editor Section -->
                <div class="mcp-json-section">
                    <label>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                            <polyline points="14 2 14 8 20 8" />
                            <line x1="16" y1="13" x2="8" y2="13" />
                            <line x1="16" y1="17" x2="8" y2="17" />
                        </svg>
                        MCP Servers Configuration (JSON)
                    </label>
                    <textarea id="mcp-json-editor" class="mcp-json-editor" placeholder='{
  "mcpServers": {
    "filesystem": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-filesystem", "/path/to/directory"]
    },
    "github": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-github"],
      "env": {
        "GITHUB_PERSONAL_ACCESS_TOKEN": "your-token-here"
      }
    }
  }
}'></textarea>
                    <div class="mcp-json-error" id="mcp-json-error">Invalid JSON format</div>
                </div>

                <!-- Server Status Section -->
                <div class="mcp-servers-section">
                    <div class="mcp-servers-header">
                        <h3>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <rect x="2" y="3" width="20" height="14" rx="2" ry="2" />
                                <line x1="8" y1="21" x2="16" y2="21" />
                                <line x1="12" y1="17" x2="12" y2="21" />
                            </svg>
                            Server Status
                        </h3>
                        <button class="mcp-refresh-btn" id="mcp-refresh-btn" title="Refresh Status">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="23 4 23 10 17 10" />
                                <polyline points="1 20 1 14 7 14" />
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
                            </svg>
                            Refresh
                        </button>
                    </div>
                    <div class="mcp-servers-list" id="mcp-servers-list">
                        <div class="mcp-no-servers">No MCP servers configured. Add servers using the JSON editor
                            above.</div>
                    </div>
                </div>
            </div>
            <div class="mcp-modal-footer">
                <button class="mcp-modal-btn cancel" id="mcp-cancel-btn">Cancel</button>
                <button class="mcp-modal-btn save" id="mcp-save-btn">Save Configuration</button>
            </div>
        </div>
    </div>

    <!-- Media Gallery Modal -->
    <div class="media-gallery-overlay" id="media-gallery-overlay">
        <div class="media-gallery-modal">
            <div class="media-gallery-header">
                <div class="media-gallery-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                    <span>Media Gallery</span>
                </div>
                <button class="media-gallery-close" id="media-gallery-close" title="Close">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="media-gallery-content">
                <div class="media-masonry" id="media-masonry">
                    <!-- 3D cards will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Apply theme immediately to prevent flash
        (function () {
            const savedTheme = localStorage.getItem('agentry-theme');
            const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            const theme = savedTheme || systemTheme;
            document.documentElement.setAttribute('data-theme', theme);
        })();

        const API_BASE = '';
        let ws = null;
        let currentSessionId = null;
        let isConnected = false;
        let isProcessing = false;
        let userInitial = '?';  // Will be set when user info loads
        let isAutoScrollEnabled = true;

        // Auth check
        // Auth check
        const token = localStorage.getItem('agentry_token');
        if (!token) {
            window.location.href = '/login';
        }

        // DOM Elements
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const emptyState = document.getElementById('empty-state');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');

        // Image upload elements
        const attachImageBtn = document.getElementById('attach-image-btn');
        const imageInput = document.getElementById('image-input');
        const imagesPreviewWrapper = document.getElementById('images-preview-wrapper');

        // Image state
        let selectedImagesData = [];  // Array of Base64 encoded image data strings

        // New Chat Button Logic
        function initNewChatButton() {
            const btn = document.getElementById('new-chat-btn');
            if (btn) {
                btn.addEventListener('click', () => {
                    currentSessionId = null;
                    clearMessages();
                    // Update URL
                    window.history.pushState({}, '', '/chat');
                    // Deactivate sidebar items
                    document.querySelectorAll('.session-item.active').forEach(item => item.classList.remove('active'));
                });
            }
        }

        // Initialize
        // Initialize
        async function init() {
            initTheme();
            initClock();
            initAgentTypeSelector();  // Initialize agent type selector
            initMCPConfiguration();   // Initialize MCP configuration handlers
            initToolsPopup();         // Initialize tools popup
            // Initialize UI controls first so they work immediately
            initSidebarControls();
            initChatSearch();
            initNewChatButton();
            initImageUpload();  // Initialize image upload handlers
            initScrollBehavior(); // Initialize scroll behavior

            await loadUserInfo();
            await loadSessions();
            await loadMedia();
            await loadMCPConfig();  // Load saved MCP configuration
            connectWebSocket();
        }

        // Clock Widget - Start immediately
        function initClock() {
            console.log('initClock called');
            updateClock();
            setInterval(updateClock, 1000);
        }

        // Call clock immediately (before auth check)
        document.addEventListener('DOMContentLoaded', initClock);

        function updateClock() {
            const now = new Date();
            const localHours = now.getHours();

            // India Time (IST - Asia/Kolkata)
            const indiaTime = now.toLocaleTimeString('en-US', {
                timeZone: 'Asia/Kolkata',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });

            // California Time (PST/PDT - America/Los_Angeles)
            const usaTime = now.toLocaleTimeString('en-US', {
                timeZone: 'America/Los_Angeles',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });

            console.log('Clock update:', indiaTime, usaTime);

            // Greeting based on local time
            let greeting;
            if (localHours >= 5 && localHours < 12) {
                greeting = 'Good Morning';
            } else if (localHours >= 12 && localHours < 17) {
                greeting = 'Good Afternoon';
            } else if (localHours >= 17 && localHours < 21) {
                greeting = 'Good Evening';
            } else {
                greeting = 'Good Night';
            }

            // Format date (local)
            const options = { weekday: 'long', month: 'long', day: 'numeric' };
            const dateStr = now.toLocaleDateString('en-US', options);

            // Update DOM
            const clockGreeting = document.getElementById('clock-greeting');
            const clockTimeIndia = document.getElementById('clock-time-india');
            const clockTimeUSA = document.getElementById('clock-time-usa');
            const clockDate = document.getElementById('clock-date');

            console.log('Elements found:', !!clockGreeting, !!clockTimeIndia, !!clockTimeUSA, !!clockDate);

            if (clockGreeting) clockGreeting.textContent = greeting;
            if (clockTimeIndia) clockTimeIndia.textContent = indiaTime;
            if (clockTimeUSA) clockTimeUSA.textContent = usaTime;
            if (clockDate) clockDate.textContent = dateStr;
        }

        // Theme Toggle
        function initTheme() {
            const toggleBtn = document.getElementById('theme-toggle-btn');
            const savedTheme = localStorage.getItem('agentry-theme');
            const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';

            // Set initial theme - default to system if no saved theme
            let currentTheme = savedTheme || systemTheme;
            document.documentElement.setAttribute('data-theme', currentTheme);
            console.log('Theme initialized:', currentTheme);

            if (toggleBtn) {
                toggleBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
                    document.documentElement.setAttribute('data-theme', newTheme);
                    localStorage.setItem('agentry-theme', newTheme);
                    console.log('Theme toggled to:', newTheme);
                });
            }
        }

        // Agent Type Selector
        const agentTypes = {
            default: { name: 'Default Agent', icon: 'M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5' },
            copilot: { name: 'Copilot Agent', icon: 'M16 18l6-6-6-6M8 6l-6 6 6 6' },
            smart: { name: 'Smart Agent', icon: 'M9 18h6M10 22h4M12 2a7 7 0 017 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 01-1 1H9a1 1 0 01-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 017-7z' }
        };

        function initAgentTypeSelector() {
            const button = document.getElementById('agent-type-button');
            const dropdown = document.getElementById('agent-type-dropdown');
            const options = document.querySelectorAll('.agent-type-option');
            const currentIcon = document.getElementById('agent-icon-current');
            const label = document.getElementById('agent-type-label');

            // Load saved agent type
            const savedAgentType = localStorage.getItem('agentry-agent-type') || 'default';
            updateAgentTypeUI(savedAgentType);

            // Toggle dropdown
            if (button) {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    button.classList.toggle('open');
                    dropdown.classList.toggle('open');
                });
            }

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.agent-type-selector')) {
                    button?.classList.remove('open');
                    dropdown?.classList.remove('open');
                }
            });

            // Handle option click
            options.forEach(option => {
                option.addEventListener('click', async () => {
                    const agentType = option.dataset.agent;

                    // Save to localStorage
                    localStorage.setItem('agentry-agent-type', agentType);

                    // Update UI
                    updateAgentTypeUI(agentType);

                    // Close dropdown
                    button?.classList.remove('open');
                    dropdown?.classList.remove('open');

                    // Show notification
                    showNotification(`Switched to ${agentTypes[agentType].name}`, 'success');
                });
            });
        }

        function updateAgentTypeUI(agentType) {
            const currentIcon = document.getElementById('agent-icon-current');
            const label = document.getElementById('agent-type-label');
            const options = document.querySelectorAll('.agent-type-option');

            // Update button label
            if (label && agentTypes[agentType]) {
                label.textContent = agentTypes[agentType].name;
            }

            // Update icon (simplified - using path data)
            if (currentIcon && agentTypes[agentType]) {
                currentIcon.innerHTML = `<path d="${agentTypes[agentType].icon}"/>`;
            }

            // Update selected state
            options.forEach(opt => {
                if (opt.dataset.agent === agentType) {
                    opt.classList.add('selected');
                } else {
                    opt.classList.remove('selected');
                }
            });

            // Toggle MCP/Tools Visibility - only available for Default Agent
            const mcpConfigBtn = document.getElementById('mcp-config-btn');
            const toolsBtnContainer = document.getElementById('tools-btn-container');

            if (agentType === 'default') {
                if (mcpConfigBtn) mcpConfigBtn.style.display = '';
                if (toolsBtnContainer) toolsBtnContainer.style.display = '';
                if (attachImageBtn) attachImageBtn.style.display = 'none';
            } else {
                if (mcpConfigBtn) mcpConfigBtn.style.display = 'none';
                if (toolsBtnContainer) toolsBtnContainer.style.display = 'none';
                if (attachImageBtn) attachImageBtn.style.display = 'flex';
            }
        }

        function showNotification(message, type = 'info') {
            // Simple notification (could be enhanced)
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // ============== MCP Configuration ==============
        let mcpConfig = { mcpServers: {} };
        let mcpServerStatuses = {};

        function initMCPConfiguration() {
            const configBtn = document.getElementById('mcp-config-btn');
            const modalOverlay = document.getElementById('mcp-modal-overlay');
            const modalClose = document.getElementById('mcp-modal-close');
            const cancelBtn = document.getElementById('mcp-cancel-btn');
            const saveBtn = document.getElementById('mcp-save-btn');
            const jsonEditor = document.getElementById('mcp-json-editor');
            const jsonError = document.getElementById('mcp-json-error');
            const refreshBtn = document.getElementById('mcp-refresh-btn');
            const inputStatusBtn = document.getElementById('mcp-input-status-btn');
            const statusPopup = document.getElementById('mcp-status-popup');
            const popupConfigLink = document.getElementById('mcp-popup-config-link');

            // Open modal from header button
            if (configBtn) {
                configBtn.addEventListener('click', () => {
                    openMCPModal();
                });
            }

            // Close modal
            if (modalClose) {
                modalClose.addEventListener('click', closeMCPModal);
            }
            if (cancelBtn) {
                cancelBtn.addEventListener('click', closeMCPModal);
            }

            // Close on overlay click
            if (modalOverlay) {
                modalOverlay.addEventListener('click', (e) => {
                    if (e.target === modalOverlay) {
                        closeMCPModal();
                    }
                });
            }

            // Validate JSON on input
            if (jsonEditor) {
                jsonEditor.addEventListener('input', () => {
                    validateMCPJson();
                });
            }

            // Save configuration
            if (saveBtn) {
                saveBtn.addEventListener('click', async () => {
                    await saveMCPConfig();
                });
            }

            // Refresh status
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    refreshMCPStatus();
                });
            }

            // Toggle status popup
            if (inputStatusBtn) {
                inputStatusBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    statusPopup?.classList.toggle('active');
                });
            }

            // Close popup on outside click
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#mcp-input-status-btn') && !e.target.closest('#mcp-status-popup')) {
                    statusPopup?.classList.remove('active');
                }
            });

            // Open modal from popup config link
            if (popupConfigLink) {
                popupConfigLink.addEventListener('click', () => {
                    statusPopup?.classList.remove('active');
                    openMCPModal();
                });
            }

            // ESC key to close modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeMCPModal();
                }
            });
        }

        function openMCPModal() {
            const modalOverlay = document.getElementById('mcp-modal-overlay');
            const jsonEditor = document.getElementById('mcp-json-editor');

            if (modalOverlay) {
                modalOverlay.classList.add('active');
            }

            // Load current config into editor
            if (jsonEditor && mcpConfig) {
                jsonEditor.value = JSON.stringify(mcpConfig, null, 2);
            }

            // Update server status list
            updateMCPServersList();
        }

        function closeMCPModal() {
            const modalOverlay = document.getElementById('mcp-modal-overlay');
            const jsonError = document.getElementById('mcp-json-error');
            const jsonEditor = document.getElementById('mcp-json-editor');

            if (modalOverlay) {
                modalOverlay.classList.remove('active');
            }
            if (jsonError) {
                jsonError.classList.remove('visible');
            }
            if (jsonEditor) {
                jsonEditor.classList.remove('error');
            }
        }

        function validateMCPJson() {
            const jsonEditor = document.getElementById('mcp-json-editor');
            const jsonError = document.getElementById('mcp-json-error');
            const saveBtn = document.getElementById('mcp-save-btn');

            if (!jsonEditor) return false;

            const value = jsonEditor.value.trim();

            if (!value) {
                jsonError?.classList.remove('visible');
                jsonEditor.classList.remove('error');
                if (saveBtn) saveBtn.disabled = false;
                return true;
            }

            try {
                const parsed = JSON.parse(value);
                jsonEditor.classList.remove('error');
                jsonError?.classList.remove('visible');
                if (saveBtn) saveBtn.disabled = false;
                return true;
            } catch (e) {
                jsonEditor.classList.add('error');
                if (jsonError) {
                    jsonError.textContent = `Invalid JSON: ${e.message}`;
                    jsonError.classList.add('visible');
                }
                if (saveBtn) saveBtn.disabled = true;
                return false;
            }
        }

        async function saveMCPConfig() {
            const jsonEditor = document.getElementById('mcp-json-editor');

            if (!validateMCPJson()) {
                return;
            }

            const value = jsonEditor?.value.trim() || '{}';

            try {
                mcpConfig = JSON.parse(value);

                // Save to backend
                const response = await fetch(`${API_BASE}/api/mcp/config`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ config: mcpConfig })
                });

                if (response.ok) {
                    showNotification('MCP configuration saved successfully', 'success');
                    closeMCPModal();

                    // Initialize server statuses as connecting
                    initMCPServerStatuses();

                    // Update UI
                    updateMCPHeaderBadge();
                    updateMCPStatusPopup();

                    // Refresh actual status after a delay
                    setTimeout(refreshMCPStatus, 1000);
                } else {
                    const error = await response.json();
                    showNotification(`Failed to save: ${error.detail || 'Unknown error'}`, 'error');
                }
            } catch (e) {
                showNotification(`Error saving config: ${e.message}`, 'error');
            }
        }

        async function loadMCPConfig() {
            try {
                const response = await fetch(`${API_BASE}/api/mcp/config`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    mcpConfig = data.config || { mcpServers: {} };

                    // Initialize statuses
                    initMCPServerStatuses();
                    updateMCPHeaderBadge();
                    updateMCPStatusPopup();

                    // Actually check status
                    setTimeout(refreshMCPStatus, 500);
                }
            } catch (e) {
                console.error('Failed to load MCP config:', e);
            }
        }

        function initMCPServerStatuses() {
            mcpServerStatuses = {};

            if (mcpConfig.mcpServers) {
                Object.keys(mcpConfig.mcpServers).forEach(serverName => {
                    mcpServerStatuses[serverName] = 'connecting';
                });
            }
        }

        async function refreshMCPStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/mcp/status`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    mcpServerStatuses = data.statuses || {};
                } else {
                    // Mark all as disconnected on error
                    Object.keys(mcpServerStatuses).forEach(k => {
                        mcpServerStatuses[k] = 'disconnected';
                    });
                }
            } catch (e) {
                // Mark all as disconnected on network error
                Object.keys(mcpServerStatuses).forEach(k => {
                    mcpServerStatuses[k] = 'disconnected';
                });
            }

            updateMCPServersList();
            updateMCPHeaderBadge();
            updateMCPStatusPopup();
        }

        function updateMCPServersList() {
            const list = document.getElementById('mcp-servers-list');
            if (!list) return;

            const servers = mcpConfig.mcpServers || {};
            const serverNames = Object.keys(servers);

            if (serverNames.length === 0) {
                list.innerHTML = '<div class="mcp-no-servers">No MCP servers configured. Add servers using the JSON editor above.</div>';
                return;
            }

            list.innerHTML = serverNames.map(name => {
                const status = mcpServerStatuses[name] || 'disconnected';
                const serverConfig = servers[name];
                const type = serverConfig.command || 'custom';

                return `
                            <div class="mcp-server-item">
                                <div class="mcp-server-info">
                                    <div class="mcp-server-status ${status}"></div>
                                    <span class="mcp-server-name">${escapeHtml(name)}</span>
                                </div>
                                <span class="mcp-server-type">${escapeHtml(type)}</span>
                            </div>
                        `;
            }).join('');
        }

        function updateMCPHeaderBadge() {
            const badge = document.getElementById('mcp-header-status');
            if (!badge) return;

            const servers = Object.keys(mcpConfig.mcpServers || {});

            if (servers.length === 0) {
                badge.className = 'mcp-status-badge none';
                return;
            }

            const statuses = Object.values(mcpServerStatuses);
            const allConnected = statuses.every(s => s === 'connected');
            const anyConnecting = statuses.some(s => s === 'connecting');

            if (allConnected) {
                badge.className = 'mcp-status-badge connected';
            } else if (anyConnecting) {
                badge.className = 'mcp-status-badge connecting';
            } else {
                badge.className = 'mcp-status-badge disconnected';
            }
        }

        function updateMCPStatusPopup() {
            const content = document.getElementById('mcp-status-popup-content');
            if (!content) return;

            const servers = mcpConfig.mcpServers || {};
            const serverNames = Object.keys(servers);

            if (serverNames.length === 0) {
                content.innerHTML = '<div class="mcp-status-popup-empty">No MCP servers configured</div>';
                return;
            }

            content.innerHTML = serverNames.map(name => {
                const status = mcpServerStatuses[name] || 'disconnected';
                const statusLabel = status === 'connected' ? 'Connected' :
                    status === 'connecting' ? 'Connecting' : 'Disconnected';

                return `
                            <div class="mcp-status-popup-item">
                                <div class="mcp-server-status ${status}"></div>
                                <span class="mcp-status-popup-name">${escapeHtml(name)}</span>
                                <span class="mcp-status-popup-badge ${status}">${statusLabel}</span>
                            </div>
                        `;
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============== Tools Management ==============
        let availableTools = { builtin: [], mcp: {} };
        let disabledTools = new Set(); // Set of tool names that are disabled

        function initToolsPopup() {
            const toolsBtn = document.getElementById('tools-btn');
            const toolsPopup = document.getElementById('tools-popup');
            const toolsPopupClose = document.getElementById('tools-popup-close');
            const mcpConfigLink = document.getElementById('tools-mcp-config-link');

            if (toolsBtn) {
                toolsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (!toolsPopup?.classList.contains('active')) {
                        loadAvailableTools();
                    }
                    toolsBtn.classList.toggle('active');
                    toolsPopup?.classList.toggle('active');
                });
            }

            if (toolsPopupClose) {
                toolsPopupClose.addEventListener('click', closeToolsPopup);
            }

            document.addEventListener('click', (e) => {
                if (!e.target.closest('#tools-btn') && !e.target.closest('#tools-popup')) {
                    closeToolsPopup();
                }
            });

            if (mcpConfigLink) {
                mcpConfigLink.addEventListener('click', () => {
                    closeToolsPopup();
                    openMCPModal();
                });
            }

            // Load tool preferences
            const savedDisabled = localStorage.getItem('agentry-disabled-tools');
            if (savedDisabled) {
                try {
                    disabledTools = new Set(JSON.parse(savedDisabled));
                } catch (e) {
                    disabledTools = new Set();
                }
            }
            loadDisabledToolsFromBackend();

            // Setup Toggles
            const mcpSectionToggle = document.getElementById('mcp-section-toggle');
            if (mcpSectionToggle) {
                mcpSectionToggle.addEventListener('change', handleMCPSectionToggle);
            }

            const builtinToggle = document.getElementById('builtin-tools-toggle');
            if (builtinToggle) {
                builtinToggle.addEventListener('change', handleBuiltinSectionToggle);
            }
        }

        async function handleMCPSectionToggle() {
            const enabled = this.checked;
            const mcpServers = availableTools.mcp || {};
            const serverNames = Object.keys(mcpServers);

            serverNames.forEach(serverName => {
                const serverKey = `mcp_server:${serverName}`;
                if (enabled) {
                    disabledTools.delete(serverKey);
                } else {
                    disabledTools.add(serverKey);
                }

                const tools = mcpServers[serverName] || [];
                tools.forEach(tool => {
                    const toolId = `mcp:${serverName}:${tool.name}`;
                    enabled ? disabledTools.delete(toolId) : disabledTools.add(toolId);
                });
            });

            renderToolsList();
            saveDisabledTools();
        }

        async function handleBuiltinSectionToggle() {
            const enabled = this.checked;
            const builtinTools = availableTools.builtin || [];
            builtinTools.forEach(tool => {
                const toolId = `builtin:${tool.name}`;
                enabled ? disabledTools.delete(toolId) : disabledTools.add(toolId);
            });
            renderToolsList();
            saveDisabledTools();
        }

        async function handleMCPServerToggle(event) {
            const serverName = event.target.dataset.server;
            const enabled = event.target.checked;
            const serverTools = availableTools.mcp?.[serverName] || [];
            const serverKey = `mcp_server:${serverName}`;

            if (enabled) {
                disabledTools.delete(serverKey);
            } else {
                disabledTools.add(serverKey);
            }

            serverTools.forEach(tool => {
                const toolId = `mcp:${serverName}:${tool.name}`;
                enabled ? disabledTools.delete(toolId) : disabledTools.add(toolId);
            });
            renderToolsList();
            saveDisabledTools();
        }

        async function handleToolToggle(event, type) {
            const toolId = event.target.dataset.toolId;
            const enabled = event.target.checked;
            enabled ? disabledTools.delete(toolId) : disabledTools.add(toolId);
            renderToolsList();
            saveDisabledTools();
        }

        async function saveDisabledTools() {
            localStorage.setItem('agentry-disabled-tools', JSON.stringify([...disabledTools]));
            try {
                await fetch(`${API_BASE}/api/tools/disabled`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ disabled_tools: [...disabledTools] })
                });
            } catch (e) {
                console.error('Failed to sync tools:', e);
            }
        }

        async function loadDisabledToolsFromBackend() {
            try {
                const response = await fetch(`${API_BASE}/api/tools/disabled`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.disabled_tools) {
                        disabledTools = new Set(data.disabled_tools);
                        localStorage.setItem('agentry-disabled-tools', JSON.stringify([...disabledTools]));
                        renderToolsList();
                    }
                }
            } catch (e) { }
        }

        function closeToolsPopup() {
            const toolsBtn = document.getElementById('tools-btn');
            const toolsPopup = document.getElementById('tools-popup');
            toolsBtn?.classList.remove('active');
            toolsPopup?.classList.remove('active');
        }

        async function loadAvailableTools() {
            try {
                const response = await fetch(`${API_BASE}/api/tools`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    availableTools = await response.json();
                    renderToolsList();
                } else {
                    renderToolsListFallback();
                }
            } catch (e) {
                renderToolsListFallback();
            }
        }

        function createToolItemHTML(tool, type) {
            const toolId = type === 'mcp' ? `mcp:${tool.server}:${tool.name}` : `builtin:${tool.name}`;
            const isDisabled = disabledTools.has(toolId);
            return `
            <div class="tool-item ${isDisabled ? 'disabled' : ''}">
                <div class="tool-item-icon ${type === 'mcp' ? 'mcp' : ''}">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
                </div>
                <div class="tool-item-info">
                    <div class="tool-item-name">${escapeHtml(tool.name)}</div>
                    <div class="tool-item-desc">${escapeHtml(tool.description || 'No description')}</div>
                </div>
                <label class="tool-toggle">
                    <input type="checkbox" data-tool-id="${toolId}" ${isDisabled ? '' : 'checked'}>
                    <span class="tool-toggle-slider"></span>
                </label>
            </div>`;
        }

        function renderToolsList() {
            const builtinList = document.getElementById('builtin-tools-list');
            const mcpList = document.getElementById('mcp-tools-list');
            const builtinCountEl = document.getElementById('builtin-tools-count');
            const mcpCountEl = document.getElementById('mcp-tools-count');
            const builtinSectionToggle = document.getElementById('builtin-tools-toggle');

            let enabledBuiltinCount = 0;

            // 1. Render Built-in Tools
            if (builtinList) {
                const builtinTools = availableTools.builtin || [];
                enabledBuiltinCount = builtinTools.filter(t => !disabledTools.has(`builtin:${t.name}`)).length;

                // Update count
                if (builtinCountEl) {
                    builtinCountEl.textContent = enabledBuiltinCount;
                }

                const allDisabled = builtinTools.length > 0 && builtinTools.every(t => disabledTools.has(`builtin:${t.name}`));
                if (builtinSectionToggle) builtinSectionToggle.checked = !allDisabled;

                if (builtinTools.length === 0) {
                    builtinList.innerHTML = '<div class="tools-empty">No built-in tools</div>';
                } else {
                    builtinList.innerHTML = builtinTools.map(t => createToolItemHTML(t, 'builtin')).join('');
                    builtinList.querySelectorAll('.tool-toggle input').forEach(input => {
                        input.addEventListener('change', (e) => handleToolToggle(e, 'builtin'));
                    });
                }
            }

            // 2. Render MCP Tools
            if (mcpList) {
                const mcpServers = availableTools.mcp || {};
                const serverNames = Object.keys(mcpServers);

                const enabledMcpTools = Object.keys(mcpServers).reduce((sum, serverName) => {
                    const tools = mcpServers[serverName] || [];
                    return sum + tools.filter(t => !disabledTools.has(`mcp:${serverName}:${t.name}`)).length;
                }, 0);

                if (mcpCountEl) {
                    mcpCountEl.textContent = enabledMcpTools;
                }

                // Update Total active tools count
                const totalToolsCountEl = document.getElementById('total-tools-count');
                if (totalToolsCountEl) {
                    const totalEnabled = enabledBuiltinCount + enabledMcpTools;
                    totalToolsCountEl.textContent = totalEnabled;
                }

                if (serverNames.length === 0) {
                    mcpList.innerHTML = '<div class="tools-empty">No MCP servers</div>';
                } else {
                    mcpList.innerHTML = serverNames.map((name, idx) => {
                        const tools = mcpServers[name] || [];
                        const status = mcpServerStatuses[name] || 'disconnected';
                        const serverId = `mcp-server-${idx}`;
                        const allDisabled = tools.length > 0 && tools.every(t => disabledTools.has(`mcp:${name}:${t.name}`));

                        // Calculate enabled count for this specific server
                        const serverEnabledCount = tools.filter(t => !disabledTools.has(`mcp:${name}:${t.name}`)).length;

                        return `
                        <div class="mcp-server-group ${allDisabled ? 'disabled-server' : ''}" id="${serverId}">
                            <div class="mcp-server-group-header" onclick="toggleMCPServerExpand('${serverId}')">
                                <div class="mcp-server-status ${status}"></div>
                                <span class="mcp-server-name">${escapeHtml(name)}</span>
                                <span class="mcp-server-tools-count">${serverEnabledCount} / ${tools.length}</span>
                                <div class="tools-toggle-wrapper" onclick="event.stopPropagation()">
                                    <label class="tools-switch">
                                        <input type="checkbox" class="mcp-server-toggle" data-server="${escapeHtml(name)}" ${allDisabled ? '' : 'checked'}>
                                        <span class="tools-slider"></span>
                                    </label>
                                </div>
                                <svg class="mcp-server-expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </div>
                            <div class="mcp-server-tools">
                                <div class="tools-list">
                                    ${tools.length > 0 ? tools.map(t => createToolItemHTML({ ...t, server: name }, 'mcp')).join('') : '<div class="tools-empty">No tools</div>'}
                                </div>
                            </div>
                        </div>`;
                    }).join('');

                    mcpList.querySelectorAll('.tool-toggle input').forEach(input => {
                        input.addEventListener('change', (e) => handleToolToggle(e, 'mcp'));
                    });
                    mcpList.querySelectorAll('.mcp-server-toggle').forEach(input => {
                        input.addEventListener('change', (e) => handleMCPServerToggle(e));
                    });
                }

                // Sync Section Toggle visual state
                const mcpSectionToggle = document.getElementById('mcp-section-toggle');
                if (mcpSectionToggle) {
                    const allDisabled = Object.keys(mcpServers).every(serverName => {
                        const tools = mcpServers[serverName] || [];
                        return tools.every(t => disabledTools.has(`mcp:${serverName}:${t.name}`));
                    });
                    mcpSectionToggle.checked = !allDisabled;
                }
            }
        }

        function renderToolsListFallback() {
            // ... (keep fallback if needed or let renderToolsList handle empty availableTools)
            // For brevity, I'll let renderToolsList handle empty states
            renderToolsList();
        }

        // Sidebar Controls (Resize & Toggle)


        // Load user info
        async function loadUserInfo() {
            try {
                const response = await fetch(`${API_BASE}/api/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    localStorage.removeItem('agentry_token');
                    window.location.href = '/login';
                    return;
                }

                const data = await response.json();

                document.getElementById('user-name').textContent = data.user.username;
                const initial = data.user.username.charAt(0).toUpperCase();
                document.getElementById('user-avatar').textContent = initial;

                if (data.provider_config) {
                    const providerIcon = document.getElementById('provider-icon');
                    const providerName = document.getElementById('provider-name');
                    const modelName = document.getElementById('model-name');

                    const provider = data.provider_config.provider;
                    providerName.textContent = provider.charAt(0).toUpperCase() + provider.slice(1);
                    modelName.textContent = data.provider_config.model || 'Default';

                    providerIcon.className = `provider-icon-small ${provider}`;
                    if (provider === 'ollama') {
                        // Ollama Logo
                        providerIcon.innerHTML = `<img src="https://github.com/ollama.png" alt="Ollama">`;
                    } else if (provider === 'groq') {
                        // Groq Logo
                        providerIcon.innerHTML = `<img src="https://github.com/groq.png" alt="Groq">`;
                    } else if (provider === 'gemini') {
                        // Gemini Logo
                        providerIcon.innerHTML = `<img src="https://www.gstatic.com/lamda/images/gemini_sparkle_v002_d4735304ff6292a690345.svg" alt="Gemini">`;
                    } else if (provider === 'azure') {
                        // Azure Logo
                        providerIcon.style.background = 'white';
                        providerIcon.innerHTML = `<img src="https://upload.wikimedia.org/wikipedia/commons/f/fa/Microsoft_Azure.svg" alt="Azure" style="width: 18px; height: 18px;">`;
                    } else {
                        providerIcon.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect><rect x="9" y="9" width="6" height="6"></rect></svg>`;
                    }

                    // Set tools enabled/disabled state
                    const globalToolsToggle = document.getElementById('global-tools-toggle');
                    if (globalToolsToggle && data.provider_config.tools_enabled !== undefined) {
                        globalToolsToggle.checked = data.provider_config.tools_enabled;
                    }
                }
            } catch (error) {
                console.error('Failed to load user info:', error);
            }
        }

        // Store sessions for search filtering
        let allSessions = [];

        // Load sessions
        async function loadSessions() {
            try {
                const response = await fetch(`${API_BASE}/api/sessions`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    allSessions = data.sessions;
                    // Get current search query and filter if needed
                    const searchInput = document.getElementById('search-chats-input');
                    const query = searchInput ? searchInput.value.trim().toLowerCase() : '';
                    if (query) {
                        const filtered = allSessions.filter(s =>
                            (s.title || 'Untitled Chat').toLowerCase().includes(query)
                        );
                        renderSessions(filtered);
                    } else {
                        renderSessions(allSessions);
                    }
                }
            } catch (error) {
                console.error('Failed to load sessions:', error);
            }
        }

        // Render sessions
        function renderSessions(sessions) {
            const container = document.getElementById('sessions-container');
            container.innerHTML = '';

            if (sessions.length === 0) {
                // Check if we're searching
                const searchInput = document.getElementById('search-chats-input');
                const isSearching = searchInput && searchInput.value.trim().length > 0;
                const emptyMessage = isSearching ? 'No matching chats found' : 'No previous chats';
                container.innerHTML = `<p style="color: var(--text-secondary); font-size: 13px; text-align: center; padding: 20px;">${emptyMessage}</p>`;
                return;
            }

            sessions.forEach(session => {
                const item = document.createElement('div');
                item.className = 'session-item';
                if (session.id === currentSessionId) item.classList.add('active');
                item.dataset.sessionId = session.id;

                const date = new Date(session.updated_at || session.created_at);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

                item.innerHTML = `
                    <div class="session-title">${escapeHtml(session.title || 'Untitled Chat')}</div>
                    <div class="session-date">${dateStr}, ${timeStr}  ${session.message_count || 0} turns</div>
                    <button class="session-delete" title="Delete session" onclick="event.stopPropagation(); deleteSession('${session.id}')">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            <line x1="10" y1="11" x2="10" y2="17"/>
                            <line x1="14" y1="11" x2="14" y2="17"/>
                        </svg>
                    </button>
                `;

                item.addEventListener('click', () => loadSession(session.id));
                container.appendChild(item);
            });
        }

        // Delete session
        async function deleteSession(sessionId) {
            if (!confirm('Are you sure you want to delete this chat? This cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/sessions/${sessionId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    // If we deleted the current session, clear the chat
                    if (sessionId === currentSessionId) {
                        currentSessionId = null;
                        clearMessages();
                    }
                    loadSessions();
                } else {
                    console.error('Failed to delete session');
                }
            } catch (error) {
                console.error('Failed to delete session:', error);
            }
        }
        // Expose to global scope for inline onclick handlers
        window.deleteSession = deleteSession;

        // Initialize Chat Search Modal
        function initChatSearch() {
            const searchModalOverlay = document.getElementById('search-modal-overlay');
            const searchToggleBtn = document.getElementById('search-toggle-btn');
            const searchInput = document.getElementById('modal-search-input');
            const resultsList = document.getElementById('modal-sessions-list');

            if (!searchModalOverlay || !searchToggleBtn || !searchInput) return;

            const openSearch = () => {
                searchModalOverlay.classList.add('active');
                setTimeout(() => searchInput.focus(), 50);
                renderModalResults(allSessions); // Show recent by default
            };

            const closeSearch = () => {
                searchModalOverlay.classList.remove('active');
                searchInput.value = '';
            };

            // Toggle search modal
            searchToggleBtn.addEventListener('click', openSearch);

            // Close modal on overlay click
            searchModalOverlay.addEventListener('click', (e) => {
                if (e.target === searchModalOverlay) closeSearch();
            });

            // Close modal on Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeSearch();
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    if (searchModalOverlay.classList.contains('active')) closeSearch();
                    else openSearch();
                }
            });

            // Debounced search function
            let searchTimeout;
            const performSearch = async () => {
                const query = searchInput.value.trim();

                if (!query) {
                    renderModalResults(allSessions);
                    return;
                }

                // Call backend API for search
                try {
                    const response = await fetch(`${API_BASE}/api/sessions/search?q=${encodeURIComponent(query)}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        renderModalResults(data.sessions, true);
                    } else {
                        // Fallback to local search on API error
                        const filtered = allSessions.filter(s =>
                            (s.title || 'Untitled Chat').toLowerCase().includes(query.toLowerCase())
                        );
                        renderModalResults(filtered);
                    }
                } catch (error) {
                    console.error('Search failed:', error);
                    const filtered = allSessions.filter(s =>
                        (s.title || 'Untitled Chat').toLowerCase().includes(query.toLowerCase())
                    );
                    renderModalResults(filtered);
                }
            };

            // Search input handler with debounce
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(performSearch, 300);
            });

            // Helper to render results in the modal
            function renderModalResults(sessions, isSearch = false) {
                resultsList.innerHTML = '';

                if (sessions.length === 0) {
                    resultsList.innerHTML = `<div class="modal-no-results">
                        <p>${isSearch ? 'No matching chats found' : 'No recent chats'}</p>
                    </div>`;
                    return;
                }

                sessions.forEach(session => {
                    const date = new Date(session.updated_at || session.created_at);
                    const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                    const item = document.createElement('div');
                    item.className = 'modal-session-item';
                    item.innerHTML = `
                        <div class="modal-session-icon">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                        </div>
                        <div class="modal-session-info">
                            <div class="modal-session-title">${escapeHtml(session.title || 'Untitled Chat')}</div>
                            <div class="modal-session-meta">
                                <span>${dateStr}</span>
                                <span></span>
                                <span>${session.message_count || 0} turns</span>
                                ${isSearch && session.score > 200 ? '<span class="modal-match-badge">High Match</span>' : ''}
                            </div>
                            ${session.snippet ? `<div class="modal-session-snippet">${escapeHtml(session.snippet)}</div>` : ''}
                        </div>
                    `;

                    item.addEventListener('click', () => {
                        loadSession(session.id);
                        closeSearch();
                    });
                    resultsList.appendChild(item);
                });
            }
        }

        // Load session
        async function loadSession(sessionId) {
            if (isProcessing) return;

            currentSessionId = sessionId;

            // Update active state
            document.querySelectorAll('.session-item').forEach(item => {
                item.classList.toggle('active', item.dataset.sessionId === sessionId);
            });

            // Request session load via WebSocket
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'load_session', session_id: sessionId }));
            }
        }

        // Create new session
        document.getElementById('new-chat-btn').addEventListener('click', async () => {
            try {
                const response = await fetch(`${API_BASE}/api/sessions`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentSessionId = data.session.id;
                    clearMessages();
                    await loadSessions();
                }
            } catch (error) {
                console.error('Failed to create session:', error);
            }
        });

        // WebSocket connection
        function connectWebSocket() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${wsProtocol}//${window.location.host}/ws/chat`);

            ws.onopen = () => {
                // Send authentication
                ws.send(JSON.stringify({ token }));
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };

            ws.onclose = () => {
                setConnectionStatus(false);
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        // Handle WebSocket messages
        let currentAssistantMessage = null;
        let currentAssistantText = '';

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'connected':
                    setConnectionStatus(true);
                    sendBtn.disabled = false;
                    // Store model capabilities for UI adaptation
                    if (data.capabilities) {
                        window.modelCapabilities = data.capabilities;
                        updateCapabilityStatus(data.capabilities);
                    }
                    break;

                case 'message_deleted':
                    console.log('[Delete] Message deleted successfully:', data);
                    if (data.session_id === currentSessionId) {
                        // Remove all faded messages immediately for snappy UI
                        document.querySelectorAll('.message[style*="opacity: 0.5"]').forEach(el => el.remove());

                        // Reload session to get fresh data and proper indices
                        console.log(`[Delete] Reloading session, ${data.deleted_count || 1} message(s) were deleted`);
                        loadSession(currentSessionId);
                    }
                    // Also refresh sidebar to update message counts
                    loadSessions();
                    break;

                case 'media_saved':
                    if (data.media) {
                        addMediaItem(data.media, true);
                        // Auto-open media container if it was closed
                        const mContainer = document.getElementById('media-container');
                        const mToggle = document.getElementById('media-library-toggle');
                        if (mContainer && mContainer.style.display === 'none') {
                            mContainer.style.display = 'grid';
                            if (mToggle) mToggle.classList.add('active');
                        }
                    }
                    break;

                case 'session_deleted':
                    console.log('[Delete] Session deleted:', data);
                    if (data.session_id === currentSessionId) {
                        // Session was deleted (all messages removed)
                        // Clear immediately
                        messagesContainer.innerHTML = '';
                        emptyState.style.display = 'flex';
                        messagesContainer.appendChild(emptyState);
                        document.getElementById('chat-title').textContent = '';

                        currentSessionId = null;
                        console.log('[Delete] Session cleared, showing new chat state');
                    }
                    // Always refresh sidebar when a session is deleted
                    loadSessions();
                    break;

                case 'error':
                    if (currentAssistantMessage) {
                        removeTypingIndicator(currentAssistantMessage);
                        currentAssistantMessage = null;
                    }
                    if (data.message.includes('Provider not configured')) {
                        window.location.href = '/setup';
                    } else {
                        addErrorMessage(data.message);
                    }
                    isProcessing = false;
                    sendBtn.disabled = false;
                    break;

                case 'token':
                    if (!currentAssistantMessage) {
                        currentAssistantMessage = createAssistantMessage();
                        currentAssistantText = '';
                    }
                    if (!currentAssistantText && data.content) {
                        removeLoadingIndicators(currentAssistantMessage);
                    }
                    currentAssistantText += data.content;
                    updateAssistantMessageText(currentAssistantMessage, currentAssistantText);
                    break;

                case 'tool_start':
                    if (!currentAssistantMessage) {
                        currentAssistantMessage = createAssistantMessage();
                        currentAssistantText = '';
                    }
                    // First, finalize any text before the tool call
                    if (currentAssistantText.trim()) {
                        updateAssistantMessageText(currentAssistantMessage, currentAssistantText);
                    }
                    // Remove any typing indicator
                    removeLoadingIndicators(currentAssistantMessage);
                    // Add the tool call
                    addToolCall(currentAssistantMessage, data.tool_name, data.args);
                    // Reset text accumulator for text that might come after
                    currentAssistantText = '';
                    break;

                case 'tool_end':
                    // Update the tool call with result
                    if (currentAssistantMessage) {
                        updateToolCallResult(currentAssistantMessage, data.tool_name, data.result);
                        showSpinner(currentAssistantMessage);
                    }
                    break;

                case 'complete':
                    // Handle the final response
                    // IMPORTANT: For non-streaming providers (Groq, Gemini), 
                    // the full response comes here, not via token events
                    if (data.content && data.content.trim()) {
                        // If no assistant message was created yet (no streaming), create one now
                        if (!currentAssistantMessage) {
                            currentAssistantMessage = createAssistantMessage();
                        }
                        // Remove typing indicator
                        removeLoadingIndicators(currentAssistantMessage);
                        // Display the full response
                        updateAssistantMessageText(currentAssistantMessage, data.content);
                    } else if (currentAssistantMessage) {
                        // Just cleanup if we already have streaming content
                        removeLoadingIndicators(currentAssistantMessage);
                    }

                    // Add copy button at the end of the message
                    if (currentAssistantMessage) {
                        addMessageActions(currentAssistantMessage);
                    }

                    // Reset state for next interaction
                    currentAssistantMessage = null;
                    currentAssistantText = '';
                    isProcessing = false;
                    sendBtn.disabled = false;
                    loadSessions(); // Refresh session list
                    break;

                case 'session_loaded':
                    renderSessionMessages(data.messages);
                    document.getElementById('chat-title').textContent = '';
                    break;

                case 'tool_approval_request':
                    // Show approval modal
                    showApprovalModal(data.tool_name, data.args);
                    break;

                case 'tool_approval_timeout':
                    // Hide modal on timeout
                    hideApprovalModal();
                    addErrorMessage(`Tool "${data.tool_name}" was denied due to timeout.`);
                    break;

                case 'pong':
                    // Keep-alive response
                    break;

                case 'session_updated':
                    // Refresh sidebar list
                    loadSessions();
                    // If current session, update header
                    if (currentSessionId === data.session_id) {
                        document.getElementById('chat-title').textContent = data.title;
                    }
                    break;
            }
        }

        // Connection status
        function setConnectionStatus(connected) {
            isConnected = connected;
            statusDot.classList.toggle('connected', connected);
            statusText.textContent = connected ? 'Connected' : 'Disconnected';
        }

        // Update capability status display
        function updateCapabilityStatus(capabilities) {
            if (!capabilities) return;

            const supportsTools = capabilities.supports_tools;
            const supportsVision = capabilities.supports_vision;

            // Update the tooltip capability items
            const capTools = document.getElementById('cap-tools');
            const capVision = document.getElementById('cap-vision');

            if (capTools) {
                if (supportsTools) {
                    capTools.classList.remove('not-supported');
                    capTools.classList.add('supported');
                } else {
                    capTools.classList.remove('supported');
                    capTools.classList.add('not-supported');
                }
            }

            if (capVision) {
                if (supportsVision) {
                    capVision.classList.remove('not-supported');
                    capVision.classList.add('supported');
                } else {
                    capVision.classList.remove('supported');
                    capVision.classList.add('not-supported');
                }
            }

            // Show/hide image upload button based on vision support
            // BUT: if we are in Default Agent, it's merged into the + menu
            if (attachImageBtn) {
                const currentAgentType = localStorage.getItem('agentry-agent-type') || 'default';
                if (currentAgentType === 'default') {
                    attachImageBtn.style.display = 'none';
                } else {
                    attachImageBtn.style.display = 'flex';
                }

                if (supportsVision) {
                    messageInput.placeholder = 'Type your message or attach an image...';
                } else {
                    messageInput.placeholder = 'Type your message...';
                }
            }

            // Log for debugging
            console.log('[Capabilities]', capabilities);
        }

        // Image upload handlers
        function initImageUpload() {
            if (!attachImageBtn || !imageInput) return;

            // Click attach button to trigger file input
            attachImageBtn.addEventListener('click', () => {
                // Clear value so same files can be selected again
                imageInput.value = '';
                imageInput.click();
            });

            const mergedUploadBtn = document.getElementById('merged-upload-btn');
            if (mergedUploadBtn) {
                mergedUploadBtn.addEventListener('click', () => {
                    imageInput.value = '';
                    imageInput.click();
                    // Close the popup after clicking
                    closeToolsPopup();
                });
            }

            // Handle file selection
            imageInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    // Filter images
                    const imageFiles = files.filter(f => f.type.startsWith('image/'));
                    if (imageFiles.length > 0) {
                        handleImageSelect(imageFiles);
                    }
                }
            });

            // Handle remove image (DELEGATION since buttons are dynamic)
            if (imagesPreviewWrapper) {
                imagesPreviewWrapper.addEventListener('click', (e) => {
                    if (e.target.closest('.image-preview-remove')) {
                        const btn = e.target.closest('.image-preview-remove');
                        const index = parseInt(btn.dataset.index);
                        removeImage(index);
                    }
                });
            }

            // Handle drag and drop (optional enhancement)
            const inputWrapper = document.querySelector('.input-wrapper');
            if (inputWrapper) {
                inputWrapper.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (window.modelCapabilities?.supports_vision) {
                        inputWrapper.style.borderColor = 'var(--accent-purple)';
                    }
                });

                inputWrapper.addEventListener('dragleave', () => {
                    inputWrapper.style.borderColor = '';
                });

                inputWrapper.addEventListener('drop', (e) => {
                    e.preventDefault();
                    inputWrapper.style.borderColor = '';

                    if (!window.modelCapabilities?.supports_vision) return;

                    const files = Array.from(e.dataTransfer.files);
                    const imageFiles = files.filter(f => f.type.startsWith('image/'));
                    if (imageFiles.length > 0) {
                        handleImageSelect(imageFiles);
                    }
                });
            }
        }

        function handleImageSelect(files) {
            // Process all selected files
            let processedCount = 0;

            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const dataUrl = e.target.result;
                    // Add to array
                    selectedImagesData.push(dataUrl);
                    processedCount++;

                    if (processedCount === files.length) {
                        renderImagePreviews();
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        function renderImagePreviews() {
            if (!imagesPreviewWrapper) return;
            imagesPreviewWrapper.innerHTML = '';

            if (selectedImagesData.length === 0) {
                imagesPreviewWrapper.style.display = 'none';
                if (attachImageBtn) attachImageBtn.classList.remove('has-image');
                return;
            }

            imagesPreviewWrapper.style.display = 'flex';
            if (attachImageBtn) attachImageBtn.classList.add('has-image');

            selectedImagesData.forEach((dataUrl, index) => {
                const item = document.createElement('div');
                item.className = 'image-preview-item';
                item.innerHTML = `
                    <img src="${dataUrl}" alt="Preview ${index + 1}">
                    <button class="image-preview-remove" data-index="${index}" title="Remove image"></button>
                `;
                imagesPreviewWrapper.appendChild(item);
            });

            updateSendButtonState();
        }

        function removeImage(index) {
            selectedImagesData.splice(index, 1);
            renderImagePreviews();
        }

        function clearSelectedImages() {
            selectedImagesData = [];
            if (imageInput) imageInput.value = '';
            renderImagePreviews();
        }

        function updateSendButtonState() {
            const hasText = messageInput.value.trim().length > 0;
            const hasImages = selectedImagesData.length > 0;
            const isSendable = (hasText || hasImages) && isConnected;
            // console.log('[UI] Update Send Button:', { hasText, hasImages, isConnected, isSendable });
            sendBtn.disabled = !isSendable;
        }

        // Message rendering
        function clearMessages() {
            messagesContainer.innerHTML = '';
            emptyState.style.display = 'flex';
            messagesContainer.appendChild(emptyState);
            document.getElementById('chat-title').textContent = '';
        }

        function hideEmptyState() {
            emptyState.style.display = 'none';
        }

        function addUserMessage(content, messageIndex = null, imageData = null, extraImages = []) {
            hideEmptyState();

            const msg = document.createElement('div');
            msg.className = 'message user';

            // Store original content
            msg.dataset.originalContent = typeof content === 'string' ? content : JSON.stringify(content);
            if (messageIndex !== null) {
                msg.dataset.messageIndex = messageIndex;
            }

            // Parse content if it's multimodal (array)
            let displayContent = content;
            let imagesFromContent = [];

            if (typeof content === 'object' && content !== null) {
                // Handle Array format (common for multimodal history)
                if (Array.isArray(content)) {
                    let textParts = [];
                    content.forEach(part => {
                        if (part.type === 'text') {
                            textParts.push(part.text || '');
                        } else if (part.type === 'image') {
                            if (part.data) {
                                // Check if needs prefix
                                let src = part.data;
                                if (!src.startsWith('data:') && !src.startsWith('http')) {
                                    src = 'data:image/png;base64,' + src;
                                }
                                imagesFromContent.push(src);
                            }
                        } else if (part.type === 'image_url') {
                            if (part.image_url && part.image_url.url) {
                                imagesFromContent.push(part.image_url.url);
                            }
                        }
                    });
                    displayContent = textParts.join('\n');
                }
                // Handle simple object
                else if (content.text) {
                    displayContent = content.text;
                }
            }

            // Combine all images
            let allImages = [...imagesFromContent];
            if (imageData) allImages.push(imageData);
            if (extraImages && Array.isArray(extraImages)) allImages.push(...extraImages);

            let imagesHtml = '';
            if (allImages.length > 0) {
                imagesHtml = `<div class="message-images-grid" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                    ${allImages.map(img => `<div class="message-image-item" style="width: 80px; height: 80px; border-radius: 8px; overflow: hidden; border: 1px solid var(--dark-border);"><img src="${img}" style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;" onclick="window.open(this.src)" title="Click to view full image"></div>`).join('')}
                </div>`;
            }

            // Simplified User Message Structure (No Avatar)
            msg.innerHTML = `
                <div class="message-content">
                    <div class="message-text">${formatMessage(displayContent)}</div>
                    ${imagesHtml}
                     <div class="message-actions">
                        <button class="message-action-btn edit-btn" title="Edit message">
                            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button class="message-action-btn delete-btn" title="Delete message">
                            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `;

            // Add edit functionality
            const editBtn = msg.querySelector('.edit-btn');
            editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                startEditMessage(msg);
            });

            // Add delete functionality
            const deleteBtn = msg.querySelector('.delete-btn');
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                console.log('[Delete] User message delete button clicked');
                deleteMessage(msg);
            });

            messagesContainer.appendChild(msg);
            scrollToBottom();

            return msg;
        }

        function startEditMessage(msgElement) {
            if (isProcessing) return;

            let contentToEdit = msgElement.dataset.originalContent;

            // Handle multimodal content (show text only)
            try {
                if (contentToEdit && contentToEdit.trim().startsWith('[')) {
                    const parsed = JSON.parse(contentToEdit);
                    if (Array.isArray(parsed)) {
                        const textParts = parsed
                            .filter(p => p.type === 'text')
                            .map(p => p.text);
                        contentToEdit = textParts.join('\n');
                    }
                }
            } catch (e) {
                // Ignore parsing errors
            }

            const contentDiv = msgElement.querySelector('.message-content');
            const textDiv = contentDiv.querySelector('.message-text');
            const actionsDiv = contentDiv.querySelector('.message-actions');

            // Hide actions and text
            actionsDiv.style.display = 'none';
            textDiv.style.display = 'none';

            // Create edit UI
            const editContainer = document.createElement('div');
            editContainer.className = 'message-edit-container';
            editContainer.innerHTML = `
                <textarea class="message-edit-input">${escapeHtml(contentToEdit)}</textarea>
                <div class="message-edit-actions">
                    <button class="btn-sm save">Save & Regenerate</button>
                    <button class="btn-sm cancel">Cancel</button>
                </div>
            `;

            contentDiv.appendChild(editContainer);

            const textarea = editContainer.querySelector('textarea');
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);

            // Cancel button
            editContainer.querySelector('.cancel').addEventListener('click', () => {
                editContainer.remove();
                actionsDiv.style.display = '';
                textDiv.style.display = '';
            });

            // Save button
            editContainer.querySelector('.save').addEventListener('click', async () => {
                const newContent = textarea.value.trim();
                if (!newContent) return;

                // Remove all messages after this one and regenerate
                await editAndRegenerate(msgElement, newContent);
            });
        }

        async function editAndRegenerate(msgElement, newContent) {
            // Find all messages after this one and remove them
            let sibling = msgElement.nextElementSibling;
            while (sibling) {
                const next = sibling.nextElementSibling;
                if (sibling !== emptyState) {
                    sibling.remove();
                }
                sibling = next;
            }

            // Update this message
            msgElement.dataset.originalContent = newContent;
            const textDiv = msgElement.querySelector('.message-text');
            textDiv.innerHTML = escapeHtml(newContent);
            textDiv.style.display = '';

            const editContainer = msgElement.querySelector('.message-edit-container');
            if (editContainer) editContainer.remove();

            const actionsDiv = msgElement.querySelector('.message-actions');
            if (actionsDiv) actionsDiv.style.display = '';

            // Send the edited message for regeneration
            if (ws && ws.readyState === WebSocket.OPEN && currentSessionId) {
                isProcessing = true;
                sendBtn.disabled = true;

                // Calculate message index (System prompt is index 0 in backend, so add 1)
                const allMessages = Array.from(messagesContainer.querySelectorAll('.message'));
                const msgIndex = allMessages.indexOf(msgElement);
                const backendIndex = msgIndex + 1;

                // Note: We send with a special flag to indicate this is an edit
                // Show thinking spinner immediately
                currentAssistantMessage = createAssistantMessage();
                currentAssistantText = '';

                ws.send(JSON.stringify({
                    type: 'message',
                    content: newContent,
                    session_id: currentSessionId,
                    is_edit: true,
                    edit_index: backendIndex
                }));
            }
        }

        async function deleteMessage(msgElement) {
            // Determine the message type for better confirmation message
            const isUserMessage = msgElement.classList.contains('user');
            const isAssistantMessage = msgElement.classList.contains('assistant');

            // Custom confirmation based on message type
            let confirmMessage = 'Are you sure you want to delete this message?';
            if (isUserMessage) {
                confirmMessage = 'Delete this message and its response? This cannot be undone.';
            } else if (isAssistantMessage) {
                confirmMessage = 'Delete this response? The original question will remain.';
            }

            if (!confirm(confirmMessage)) return;

            let backendIndex;

            // Prefer explicit index if available (from session load)
            if (msgElement.dataset.messageIndex) {
                backendIndex = parseInt(msgElement.dataset.messageIndex, 10);
            } else {
                // Fallback for new messages created before reload
                const allMessages = Array.from(messagesContainer.querySelectorAll('.message'));
                const domIndex = allMessages.indexOf(msgElement);
                if (domIndex === -1) {
                    console.error('[Delete] Could not find message in DOM');
                    return;
                }

                // Fallback estimation (System prompt is at index 0 in backend)
                backendIndex = domIndex + 1;
            }

            console.log(`[Delete] Deleting ${isUserMessage ? 'user' : 'assistant'} message at backend index ${backendIndex}`);

            if (ws && ws.readyState === WebSocket.OPEN && currentSessionId) {
                // Optimistic visual feedback - fade out the message being deleted
                msgElement.style.opacity = '0.5';
                msgElement.style.pointerEvents = 'none';
                msgElement.style.transition = 'opacity 0.3s ease';

                // If deleting a user message, also fade the following response(s)
                if (isUserMessage) {
                    let sibling = msgElement.nextElementSibling;
                    while (sibling && !sibling.classList.contains('user') && sibling !== emptyState) {
                        sibling.style.opacity = '0.5';
                        sibling.style.pointerEvents = 'none';
                        sibling.style.transition = 'opacity 0.3s ease';
                        sibling = sibling.nextElementSibling;
                    }
                }

                ws.send(JSON.stringify({
                    type: 'delete_message',
                    session_id: currentSessionId,
                    index: backendIndex
                }));
            } else {
                console.error('[Delete] WebSocket not connected or no session');
                msgElement.style.opacity = '1';
                msgElement.style.pointerEvents = 'auto';
            }
        }

        function createAssistantMessage(messageIndex = null) {
            hideEmptyState();

            const msg = document.createElement('div');
            msg.className = 'message assistant';
            if (messageIndex !== null) {
                msg.dataset.messageIndex = messageIndex;
            }

            // Thinking expander comes FIRST (at top), then message-text after
            msg.innerHTML = `
                <div class="message-content">
                    <div class="spinner-container">
                        ${getSpinnerHTML()}
                    </div>
                    <div class="message-text" style="display:none;"></div>
                </div>
            `;

            // Note: message-actions (copy button) will be added when message is complete

            messagesContainer.appendChild(msg);

            // Initialize thinking expander click handlers
            initThinkingExpanderHandlers(msg);

            scrollToBottom();
            return msg;
        }

        function updateAssistantMessage(msgElement, content) {
            const textDiv = msgElement.querySelector('.message-text');
            textDiv.innerHTML = formatMessage(content);
            scrollToBottom();
        }

        // Add message actions (copy button) at the end of the message
        function addMessageActions(msgElement) {
            const contentDiv = msgElement.querySelector('.message-content');

            // Check if already exists
            if (contentDiv.querySelector('.message-actions')) {
                return;
            }

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'message-actions';
            actionsDiv.style.display = 'flex';
            actionsDiv.style.gap = '6px';
            actionsDiv.innerHTML = `
                <button class="message-action-btn copy-btn" title="Copy response">
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                    </svg>
                </button>
                <button class="message-action-btn delete-btn" title="Delete message">
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            `;

            // Add to the END of message-content
            contentDiv.appendChild(actionsDiv);

            // Add delete functionality
            const deleteBtn = actionsDiv.querySelector('.delete-btn');
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                console.log('[Delete] Assistant message delete button clicked');
                deleteMessage(msgElement);
            });

            // Add copy functionality
            const copyBtn = actionsDiv.querySelector('.copy-btn');
            copyBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                // Get all text content from message (excluding tool calls details)
                const textDivs = msgElement.querySelectorAll('.message-text, .message-text-after');
                let text = '';
                textDivs.forEach(div => {
                    text += div.innerText + '\n';
                });
                copyToClipboard(text.trim(), copyBtn);
            });
        }

        // Update text - handles adding text after tool calls
        function updateAssistantMessageText(msgElement, content) {
            // We do NOT inherently remove the spinner here because 'token' events might stream 
            // while spinner should be gone. We handle removal explicitly in 'token' event or here if content exists.
            if (content && content.length > 0) {
                removeLoadingIndicators(msgElement);
            }

            if (!content || !content.trim()) return;

            const contentDiv = msgElement.querySelector('.message-content');
            const toolsContainer = contentDiv.querySelector('.tool-calls-container');
            const spinnerContainer = contentDiv.querySelector('.spinner-container');

            // If there's a tool calls container, add/update text block after it
            if (toolsContainer) {
                let afterTextDiv = toolsContainer.nextElementSibling;

                // Check if there's already a text div after the container
                if (!afterTextDiv || !afterTextDiv.classList.contains('message-text-after')) {
                    afterTextDiv = document.createElement('div');
                    afterTextDiv.className = 'message-text message-text-after';
                    toolsContainer.parentNode.insertBefore(afterTextDiv, toolsContainer.nextSibling);
                }

                const newContent = formatMessage(content);
                if (afterTextDiv.innerHTML !== newContent) {
                    afterTextDiv.innerHTML = newContent;
                }
                // Always ensure visibility, even if content didn't change (it might be hidden)
                afterTextDiv.style.display = 'block';
            } else {
                // No tool calls yet, use the regular message-text div
                let textDiv = contentDiv.querySelector('.message-text');
                if (!textDiv) {
                    textDiv = document.createElement('div');
                    textDiv.className = 'message-text';
                    // Insert after spinner-container (thinking expander) if it exists
                    if (spinnerContainer) {
                        spinnerContainer.parentNode.insertBefore(textDiv, spinnerContainer.nextSibling);
                    } else {
                        contentDiv.appendChild(textDiv);
                    }
                }

                const newContent = formatMessage(content);
                if (textDiv.innerHTML !== newContent) {
                    textDiv.innerHTML = newContent;
                }
                // Always ensure visibility
                textDiv.style.display = 'block';
            }
            scrollToBottom();
        }


        // Track thinking start time for duration display
        let thinkingStartTime = null;

        // Processing indicator for normal response generation
        function getProcessingIndicatorHTML() {
            return `
            <div class="processing-indicator" data-start-time="${Date.now()}">
                <span class="processing-text">
                    Processing
                    <span class="processing-dots">
                        <span class="processing-dot"></span>
                        <span class="processing-dot"></span>
                        <span class="processing-dot"></span>
                    </span>
                </span>
            </div>`;
        }

        // Thinking indicator - for actual reasoning/planning mode (future use)
        function getThinkingIndicatorHTML() {
            return `
            <div class="thinking-indicator" data-start-time="${Date.now()}">
                <span class="thinking-text">Thinking</span>
            </div>`;
        }

        // Default spinner uses processing indicator
        function getSpinnerHTML() {
            return getProcessingIndicatorHTML();
        }

        // Alias for old function name
        function getThinkingExpanderHTML() {
            return getProcessingIndicatorHTML();
        }

        // Complete the thinking indicator and collapse it
        function completeThinkingExpander(msgElement) {
            if (!msgElement) return;

            const indicator = msgElement.querySelector('.thinking-indicator');
            if (!indicator) return;

            // Calculate duration
            const startTime = parseInt(indicator.dataset.startTime || Date.now());
            const duration = Math.round((Date.now() - startTime) / 1000);

            // If duration is 0, hide the indicator entirely
            if (duration <= 0) {
                indicator.style.display = 'none';
                return;
            }

            const durationText = duration < 60 ? `${duration}s` : `${Math.floor(duration / 60)}m ${duration % 60}s`;

            // Mark as completed
            indicator.classList.add('completed');
            indicator.classList.add('collapsed');

            // Update the text to show completion
            const textEl = indicator.querySelector('.thinking-text');
            if (textEl) {
                textEl.textContent = 'Thought for ' + durationText;
            }

            // Update toggle arrow
            const toggle = indicator.querySelector('.thinking-toggle');
            if (toggle) toggle.textContent = '';
        }

        // Initialize thinking indicator click handlers (called after creation)
        function initThinkingExpanderHandlers(msgElement) {
            if (!msgElement) return;

            const indicator = msgElement.querySelector('.thinking-indicator');
            if (!indicator) return;

            indicator.addEventListener('click', function (e) {
                e.stopPropagation();
                indicator.classList.toggle('collapsed');
                const toggle = indicator.querySelector('.thinking-toggle');
                if (toggle) {
                    toggle.textContent = indicator.classList.contains('collapsed') ? '' : '';
                }
            });
        }

        function showSpinner(msgElement) {
            if (!msgElement) return;
            const contentDiv = msgElement.querySelector('.message-content');
            // Check for existing indicators or spinners
            if (contentDiv.querySelector('.processing-indicator') ||
                contentDiv.querySelector('.thinking-indicator') ||
                contentDiv.querySelector('.thinking-expander') ||
                contentDiv.querySelector('.spinner-container') ||
                contentDiv.querySelector('[class^="spinner-"]')) return;

            const container = document.createElement('div');
            container.className = 'spinner-container';
            container.innerHTML = getSpinnerHTML();
            contentDiv.appendChild(container);

            scrollToBottom();
        }

        function removeLoadingIndicators(msgElement) {
            if (!msgElement) return;

            // Remove processing indicator (simple removal, no completion state)
            const processingIndicator = msgElement.querySelector('.processing-indicator');
            if (processingIndicator) {
                processingIndicator.remove();
            }

            // Complete thinking indicator (Gemini-style - keeps reference)
            const thinkingIndicator = msgElement.querySelector('.thinking-indicator:not(.completed)');
            if (thinkingIndicator) {
                completeThinkingExpander(msgElement);
                // Don't remove, it stays collapsed for reference
            }

            // Complete thinking expander (legacy style) 
            const thinkingExpander = msgElement.querySelector('.thinking-expander:not(.completed)');
            if (thinkingExpander) {
                completeThinkingExpander(msgElement);
            }

            // Remove legacy spinners
            const spinners = msgElement.querySelectorAll('.spinner, .spinner-quantum, .spinner-wave, .spinner-retro, .spinner-orbital, .spinner-pulse, .spinner-bars');
            spinners.forEach(s => s.remove());

            // Remove spinner-container only if it doesn't contain thinking indicator/expander
            const spinnerContainers = msgElement.querySelectorAll('.spinner-container');
            spinnerContainers.forEach(container => {
                if (!container.querySelector('.thinking-indicator') && !container.querySelector('.thinking-expander')) {
                    container.remove();
                }
            });

            // Remove old typing indicators if any exist
            const indicators = msgElement.querySelectorAll('.typing-indicator');
            indicators.forEach(indicator => {
                indicator.remove();
            });

            // Hide or remove empty message-text divs that only contained the indicator
            const textDivs = msgElement.querySelectorAll('.message-text');
            textDivs.forEach(div => {
                // If the div is now empty (only had indicator), hide it
                const content = div.textContent.trim();
                const hasRealContent = div.querySelector('p, h1, h2, h3, h4, h5, h6, ul, ol, pre, table, blockquote');
                if (content === '' && !hasRealContent) {
                    div.style.display = 'none';
                }
            });
        }

        function addToolCall(msgElement, toolName, args) {
            const contentDiv = msgElement.querySelector('.message-content');

            // Get or create tool calls container
            let toolsContainer = contentDiv.querySelector('.tool-calls-container');
            if (!toolsContainer) {
                toolsContainer = document.createElement('div');
                toolsContainer.className = 'tool-calls-container';
                // Insert after spinner-container (thinking expander), but before message-text
                const spinnerContainer = contentDiv.querySelector('.spinner-container');
                const textDiv = contentDiv.querySelector('.message-text');
                if (spinnerContainer) {
                    // Insert right after the thinking expander
                    spinnerContainer.parentNode.insertBefore(toolsContainer, spinnerContainer.nextSibling);
                } else if (textDiv) {
                    contentDiv.insertBefore(toolsContainer, textDiv);
                } else {
                    contentDiv.appendChild(toolsContainer);
                }
            }

            const toolDiv = document.createElement('div');
            toolDiv.className = 'tool-call collapsed';
            toolDiv.dataset.toolName = toolName;

            // Build args HTML if present with section title
            let argsHtml = '';
            if (args && typeof args === 'object' && Object.keys(args).length > 0) {
                argsHtml = `
                    <div class="tool-call-section">
                        <div class="tool-call-section-title">Tool Params</div>
                        <div class="tool-call-args">${escapeHtml(JSON.stringify(args, null, 2))}</div>
                    </div>
                `;
            }

            // Spinner HTML
            const spinnerHtml = `
                <span class="tool-spinner">
                    <span class="tool-spinner-leaf"></span>
                    <span class="tool-spinner-leaf"></span>
                    <span class="tool-spinner-leaf"></span>
                    <span class="tool-spinner-leaf"></span>
                    <span class="tool-spinner-leaf"></span>
                    <span class="tool-spinner-leaf"></span>
                    <span class="tool-spinner-leaf"></span>
                    <span class="tool-spinner-leaf"></span>
                </span>
            `;

            // Create compact chip HTML with expandable body and spinner
            toolDiv.innerHTML = `
                <div class="tool-call-header">
                    <span class="tool-call-name">${escapeHtml(toolName)}</span>
                    ${spinnerHtml}
                    <span class="tool-call-toggle"></span>
                </div>
                <div class="tool-call-body">
                    ${argsHtml}
                </div>
            `;

            // Add click to toggle expanded/collapsed state
            const header = toolDiv.querySelector('.tool-call-header');
            header.addEventListener('click', function (e) {
                e.stopPropagation();

                // Close all other open tool calls first
                document.querySelectorAll('.tool-call:not(.collapsed)').forEach(tc => {
                    if (tc !== toolDiv) {
                        tc.classList.add('collapsed');
                        const toggle = tc.querySelector('.tool-call-toggle');
                        if (toggle) toggle.textContent = '';
                    }
                });

                // Toggle this one
                toolDiv.classList.toggle('collapsed');
                const toggle = toolDiv.querySelector('.tool-call-toggle');
                toggle.textContent = toolDiv.classList.contains('collapsed') ? '' : '';
            });

            toolsContainer.appendChild(toolDiv);
            scrollToBottom();
        }

        // Close tool call dropdowns when clicking outside
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.tool-call')) {
                document.querySelectorAll('.tool-call:not(.collapsed)').forEach(tc => {
                    tc.classList.add('collapsed');
                });
            }
        });

        function updateToolCallResult(msgElement, toolName, result) {
            const contentDiv = msgElement.querySelector('.message-content');
            const toolDivs = contentDiv.querySelectorAll('.tool-call');

            // Find the tool call by name (last matching one that's not completed)
            let targetToolDiv = null;
            toolDivs.forEach(div => {
                if (div.dataset.toolName === toolName && !div.classList.contains('completed')) {
                    targetToolDiv = div;
                }
            });

            if (targetToolDiv) {
                let isSuccess = true;

                // Try to detect failure
                if (result && typeof result === 'object') {
                    if (result.success === false) isSuccess = false;
                    if (result.error) isSuccess = false;
                } else if (typeof result === 'string') {
                    if (result.toLowerCase().includes('error') || result.includes('STDERR')) isSuccess = false;
                }

                // Mark as completed or failed
                targetToolDiv.classList.add('completed');
                if (!isSuccess) {
                    targetToolDiv.classList.add('failed');
                }

                // Add result to the body with section title
                if (result) {
                    let bodyDiv = targetToolDiv.querySelector('.tool-call-body');
                    if (!bodyDiv) {
                        bodyDiv = document.createElement('div');
                        bodyDiv.className = 'tool-call-body';
                        targetToolDiv.appendChild(bodyDiv);
                    }

                    // Add result section if not already present
                    if (!bodyDiv.querySelector('.tool-call-result')) {
                        const sectionDiv = document.createElement('div');
                        sectionDiv.className = 'tool-call-section';

                        const titleDiv = document.createElement('div');
                        titleDiv.className = 'tool-call-section-title';
                        titleDiv.textContent = 'Tool Result';
                        sectionDiv.appendChild(titleDiv);

                        const resultDiv = document.createElement('div');
                        resultDiv.className = 'tool-call-result';
                        const resultText = typeof result === 'string' ? result : JSON.stringify(result, null, 2);
                        resultDiv.textContent = resultText.substring(0, 1000);
                        if (resultText.length > 1000) {
                            resultDiv.textContent += '\n... (truncated)';
                        }
                        sectionDiv.appendChild(resultDiv);
                        bodyDiv.appendChild(sectionDiv);
                    }
                }

                targetToolDiv.classList.add('collapsed');
                scrollToBottom();
            }
        }

        function addErrorMessage(message) {
            const msg = document.createElement('div');
            msg.className = 'message assistant';
            msg.innerHTML = `
                <div class="message-avatar" style="background: var(--error-color);"></div>
                <div class="message-content">
                    <div class="message-role">Error</div>
                    <div class="message-text" style="color: var(--error-color);">${escapeHtml(message)}</div>
                </div>
            `;
            messagesContainer.appendChild(msg);
            scrollToBottom();
        }

        function renderSessionMessages(messages) {
            messagesContainer.innerHTML = '';

            if (!messages || messages.length === 0) {
                messagesContainer.appendChild(emptyState);
                emptyState.style.display = 'flex';
                return;
            }

            emptyState.style.display = 'none';

            let currentAssistantEl = null;
            let lastRole = null;

            messages.forEach((msg, idx) => {
                if (msg.role === 'user') {
                    // Add copy button to previous assistant before moving to user message
                    if (currentAssistantEl) {
                        addMessageActions(currentAssistantEl);
                    }

                    const content = msg.content;
                    addUserMessage(content, idx);
                    currentAssistantEl = null;
                    lastRole = 'user';
                } else if (msg.role === 'assistant') {
                    // Only create a new assistant message block if:
                    // 1. There's no current one, OR
                    // 2. The previous message was a user message (new turn)
                    // If previous was 'tool', we're continuing the same response
                    if (!currentAssistantEl || lastRole === 'user') {
                        currentAssistantEl = createAssistantMessage(idx);
                        removeLoadingIndicators(currentAssistantEl);
                    }

                    const content = typeof msg.content === 'string' ? msg.content : (msg.content || '');
                    if (content) {
                        updateAssistantMessageText(currentAssistantEl, content);
                    }

                    // Check for tool_calls in the message
                    if (msg.tool_calls && Array.isArray(msg.tool_calls)) {
                        msg.tool_calls.forEach(tc => {
                            const toolName = tc.function?.name || tc.name || 'unknown';
                            const toolArgs = tc.function?.arguments || tc.arguments || {};
                            const parsedArgs = typeof toolArgs === 'string' ? JSON.parse(toolArgs) : toolArgs;
                            addToolCallToElement(currentAssistantEl, toolName, parsedArgs, null, false);
                        });
                    }

                    // Ensure typing indicator is removed after all content is added
                    removeLoadingIndicators(currentAssistantEl);
                    lastRole = 'assistant';
                } else if (msg.role === 'tool') {
                    // Tool result - update the last tool call
                    if (currentAssistantEl) {
                        const toolName = msg.name || msg.tool_call_id || 'tool';
                        let result = msg.content;
                        try {
                            if (typeof result === 'string') {
                                const parsed = JSON.parse(result);
                                result = typeof parsed === 'object' ? JSON.stringify(parsed, null, 2) : result;
                            }
                        } catch (e) { }

                        // Mark the tool as completed
                        updateToolCallResultByName(currentAssistantEl, toolName, result);

                        // Remove any lingering typing indicator
                        removeLoadingIndicators(currentAssistantEl);
                    }
                    lastRole = 'tool';
                }
            });

            // Add copy button to the last assistant message
            if (currentAssistantEl) {
                addMessageActions(currentAssistantEl);
            }

            scrollToBottom();
        }

        // Helper to add tool call to a specific element (for session loading)
        function addToolCallToElement(msgElement, toolName, args, result, completed) {
            const contentDiv = msgElement.querySelector('.message-content');

            // Get or create tool calls container
            let toolsContainer = contentDiv.querySelector('.tool-calls-container');
            if (!toolsContainer) {
                toolsContainer = document.createElement('div');
                toolsContainer.className = 'tool-calls-container';
                const roleDiv = contentDiv.querySelector('.message-role');
                const textDiv = contentDiv.querySelector('.message-text');
                if (textDiv) {
                    contentDiv.insertBefore(toolsContainer, textDiv);
                } else if (roleDiv) {
                    contentDiv.insertBefore(toolsContainer, roleDiv.nextSibling);
                } else {
                    contentDiv.appendChild(toolsContainer);
                }
            }

            const toolDiv = document.createElement('div');
            // Minimal chip design - border color indicates status
            toolDiv.className = 'tool-call collapsed' + (completed ? ' completed' : '');
            toolDiv.dataset.toolName = toolName;

            // Build args HTML if present with section title
            let argsHtml = '';
            if (args && typeof args === 'object' && Object.keys(args).length > 0) {
                argsHtml = `
                    <div class="tool-call-section">
                        <div class="tool-call-section-title">Tool Params</div>
                        <div class="tool-call-args">${escapeHtml(JSON.stringify(args, null, 2))}</div>
                    </div>
                `;
            }

            // Build result HTML if present with section title
            let resultHtml = '';
            if (result && completed) {
                const resultText = typeof result === 'string' ? result.substring(0, 1000) : JSON.stringify(result, null, 2).substring(0, 1000);
                resultHtml = `
                    <div class="tool-call-section">
                        <div class="tool-call-section-title">Tool Result</div>
                        <div class="tool-call-result">${escapeHtml(resultText)}</div>
                    </div>
                `;
            }

            // Spinner HTML (only shown if not completed)
            const spinnerHtml = !completed ? `
                <span class="tool-spinner">
                    <span class="tool-spinner-leaf"></span>
                    <span class="tool-spinner-leaf"></span>
                    <span class="tool-spinner-leaf"></span>
                    <span class="tool-spinner-leaf"></span>
                    <span class="tool-spinner-leaf"></span>
                    <span class="tool-spinner-leaf"></span>
                    <span class="tool-spinner-leaf"></span>
                    <span class="tool-spinner-leaf"></span>
                </span>
            ` : '';

            // Chip with expandable body
            toolDiv.innerHTML = `
                <div class="tool-call-header">
                    <span class="tool-call-name">${escapeHtml(toolName)}</span>
                    ${spinnerHtml}
                    <span class="tool-call-toggle"></span>
                </div>
                <div class="tool-call-body">
                    ${argsHtml}
                    ${resultHtml}
                </div>
            `;

            // Add toggle functionality
            const header = toolDiv.querySelector('.tool-call-header');
            header.addEventListener('click', function (e) {
                e.stopPropagation();
                document.querySelectorAll('.tool-call:not(.collapsed)').forEach(tc => {
                    if (tc !== toolDiv) {
                        tc.classList.add('collapsed');
                        const toggle = tc.querySelector('.tool-call-toggle');
                        if (toggle) toggle.textContent = '';
                    }
                });
                toolDiv.classList.toggle('collapsed');
                const toggle = toolDiv.querySelector('.tool-call-toggle');
                toggle.textContent = toolDiv.classList.contains('collapsed') ? '' : '';
            });

            toolsContainer.appendChild(toolDiv);
        }

        function updateToolCallResultByName(msgElement, toolName, result) {
            const contentDiv = msgElement.querySelector('.message-content');
            const toolDivs = contentDiv.querySelectorAll('.tool-call:not(.completed)');

            // Find first uncompleted tool call
            if (toolDivs.length > 0) {
                const targetToolDiv = toolDivs[0];

                // Check for failure
                let isSuccess = true;
                if (result && typeof result === 'string') {
                    if (result.toLowerCase().includes('error') || result.includes('STDERR')) {
                        isSuccess = false;
                    }
                }

                // Mark as completed or failed - CSS handles the border color
                targetToolDiv.classList.add('completed');
                if (!isSuccess) {
                    targetToolDiv.classList.add('failed');
                }

                // Add result to the body with section title
                if (result) {
                    let bodyDiv = targetToolDiv.querySelector('.tool-call-body');
                    if (!bodyDiv) {
                        bodyDiv = document.createElement('div');
                        bodyDiv.className = 'tool-call-body';
                        targetToolDiv.appendChild(bodyDiv);
                    }

                    // Add result section if not already present
                    if (!bodyDiv.querySelector('.tool-call-result')) {
                        const sectionDiv = document.createElement('div');
                        sectionDiv.className = 'tool-call-section';

                        const titleDiv = document.createElement('div');
                        titleDiv.className = 'tool-call-section-title';
                        titleDiv.textContent = 'Tool Result';
                        sectionDiv.appendChild(titleDiv);

                        const resultDiv = document.createElement('div');
                        resultDiv.className = 'tool-call-result';
                        const resultText = typeof result === 'string' ? result : JSON.stringify(result, null, 2);
                        resultDiv.textContent = resultText.substring(0, 1000);
                        if (resultText.length > 1000) {
                            resultDiv.textContent += '\n... (truncated)';
                        }
                        sectionDiv.appendChild(resultDiv);
                        bodyDiv.appendChild(sectionDiv);
                    }
                }

                targetToolDiv.classList.add('collapsed');
            }
        }

        // Helpers
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatMessage(content) {
            if (!content) return '';

            // Handle multimodal content (array)
            if (Array.isArray(content)) {
                return content.map(part => {
                    if (part.type === 'text') return formatMessage(part.text);
                    if (part.type === 'image') {
                        // Handle both raw base64 and data URLs
                        let src = part.data || part.url;
                        if (src && !src.startsWith('data:') && !src.startsWith('http') && !src.startsWith('/')) {
                            src = `data:image/png;base64,${src}`;
                        }
                        return `<div class="message-image"><img src="${src}" onclick="window.open(this.src)" title="Click to view full image" /></div>`;
                    }
                    return '';
                }).join('');
            }

            const text = content;
            if (typeof text !== 'string') return '';

            // Create custom renderer to wrap code blocks and tables with copy buttons
            const renderer = new marked.Renderer();

            // Custom code block renderer - handles both marked v4+ (object) and legacy (separate params)
            renderer.code = function (codeOrToken, language, escaped) {
                // Handle marked.js v4+ where first param is a token object
                let code, lang;
                if (typeof codeOrToken === 'object' && codeOrToken !== null) {
                    code = codeOrToken.text || codeOrToken.raw || '';
                    lang = codeOrToken.lang || 'plaintext';
                } else {
                    code = codeOrToken || '';
                    lang = language || 'plaintext';
                }

                const displayLang = lang === 'plaintext' ? 'text' : lang;

                let highlightedCode;
                try {
                    const validLang = highlight.getLanguage(lang) ? lang : 'plaintext';
                    highlightedCode = highlight.highlight(code, { language: validLang }).value;
                } catch (e) {
                    highlightedCode = escapeHtml(code);
                }

                // Create unique ID for this code block
                const blockId = 'code-' + Math.random().toString(36).substr(2, 9);

                return `
                    <div class="code-block-container" data-block-id="${blockId}">
                        <div class="code-block-header">
                            <span class="code-block-language">${escapeHtml(displayLang)}</span>
                            <button class="copy-block-btn" onclick="copyCodeBlock(this, '${blockId}')" title="Copy code">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                                <span>Copy</span>
                            </button>
                        </div>
                        <pre><code class="hljs language-${lang}" data-code="${btoa(unescape(encodeURIComponent(code)))}">${highlightedCode}</code></pre>
                    </div>
                `;
            };

            // Custom table renderer - handles both marked v4+ (object) and legacy (separate params)
            renderer.table = function (headerOrToken, body) {
                let header, tableBody;
                // Handle marked.js v4+ where first param is a token object
                if (typeof headerOrToken === 'object' && headerOrToken !== null && headerOrToken.header) {
                    // v4+ format: token object with header and rows arrays
                    const token = headerOrToken;

                    // Build header HTML - use parseInline for markdown rendering
                    header = '<tr>' + token.header.map(cell => {
                        const rawText = cell.text || (cell.tokens ? cell.tokens.map(t => t.raw || t.text || '').join('') : '');
                        // Parse inline markdown (bold, italic, code, etc.)
                        const parsedText = marked.parseInline ? marked.parseInline(rawText) : rawText;
                        return `<th>${parsedText}</th>`;
                    }).join('') + '</tr>';

                    // Build body HTML - use parseInline for markdown rendering
                    tableBody = token.rows.map(row => {
                        return '<tr>' + row.map(cell => {
                            const rawText = cell.text || (cell.tokens ? cell.tokens.map(t => t.raw || t.text || '').join('') : '');
                            // Parse inline markdown (bold, italic, code, etc.)
                            const parsedText = marked.parseInline ? marked.parseInline(rawText) : rawText;
                            return `<td>${parsedText}</td>`;
                        }).join('') + '</tr>';
                    }).join('');
                } else {
                    // Legacy format: separate header and body strings
                    header = headerOrToken || '';
                    tableBody = body || '';
                }

                const blockId = 'table-' + Math.random().toString(36).substr(2, 9);
                return `
                    <div class="table-container" data-block-id="${blockId}">
                        <div class="table-header">
                            <span class="table-header-label">table</span>
                            <button class="copy-block-btn" onclick="copyTableBlock(this, '${blockId}')" title="Copy table">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                                <span>Copy</span>
                            </button>
                        </div>
                        <div class="table-scroll-wrapper">
                            <table>
                                <thead>${header}</thead>
                                <tbody>${tableBody}</tbody>
                            </table>
                        </div>
                    </div>
                `;
            };

            // Configure marked options
            marked.setOptions({
                renderer: renderer,
                langPrefix: 'hljs language-',
                pedantic: false,
                gfm: true,
                breaks: true,
                sanitize: false,
                smartLists: true,
                smartypants: false,
                xhtml: false
            });

            try {
                return marked.parse(text);
            } catch (e) {
                console.error('Markdown parsing error:', e);
                return text;
            }
        }

        // Copy code block content
        async function copyCodeBlock(btn, blockId) {
            try {
                const container = btn.closest('.code-block-container');
                const codeEl = container.querySelector('code');

                // Decode the original code from base64
                const encodedCode = codeEl.dataset.code;
                const code = decodeURIComponent(escape(atob(encodedCode)));

                await navigator.clipboard.writeText(code);

                // Visual feedback
                const originalHtml = btn.innerHTML;
                btn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    <span>Copied!</span>
                `;
                btn.classList.add('copied');

                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.classList.remove('copied');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy code:', err);
            }
        }

        // Copy table content as markdown
        async function copyTableBlock(btn, blockId) {
            try {
                const container = btn.closest('.table-container');
                const table = container.querySelector('table');

                // Convert table to markdown format
                let markdown = '';
                const rows = table.querySelectorAll('tr');

                rows.forEach((row, rowIndex) => {
                    const cells = row.querySelectorAll('th, td');
                    const cellTexts = Array.from(cells).map(cell => cell.textContent.trim());
                    markdown += '| ' + cellTexts.join(' | ') + ' |\n';

                    // Add separator after header
                    if (rowIndex === 0 && row.querySelector('th')) {
                        markdown += '|' + cellTexts.map(() => '---').join('|') + '|\n';
                    }
                });

                await navigator.clipboard.writeText(markdown.trim());

                // Visual feedback
                const originalHtml = btn.innerHTML;
                btn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    <span>Copied!</span>
                `;
                btn.classList.add('copied');

                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.classList.remove('copied');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy table:', err);
            }
        }

        function scrollToBottom(force = false) {
            if (force || isAutoScrollEnabled) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                if (force) {
                    isAutoScrollEnabled = true;
                    const scrollBtn = document.getElementById('scroll-bottom-btn');
                    if (scrollBtn) scrollBtn.classList.remove('visible');
                }
            }
        }

        function initScrollBehavior() {
            const scrollBtn = document.getElementById('scroll-bottom-btn');

            messagesContainer.addEventListener('scroll', () => {
                // Check if user is near bottom
                const threshold = 100; // pixels from bottom
                const isNearBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight < threshold;

                if (isNearBottom) {
                    isAutoScrollEnabled = true;
                    scrollBtn.classList.remove('visible');
                } else {
                    // If we just scrolled up manually
                    if (isAutoScrollEnabled) {
                        // We check if it was an actual manual scroll or an auto-scroll
                        // Since scrollToBottom sets scrollTop, it triggers this event.
                        // But we only disable auto-scroll if the scroll event wasn't triggered by an auto-scroll.
                        // However, a simple way is: if scroll event happens and we are NOT near bottom,
                        // and it wasn't exactly at scrollHeight, we can show the button.
                        isAutoScrollEnabled = false;
                    }
                    scrollBtn.classList.add('visible');
                }
            });

            if (scrollBtn) {
                scrollBtn.addEventListener('click', () => {
                    scrollToBottom(true);
                });
            }
        }

        // Send message
        // Send message
        function sendMessage() {
            const content = messageInput.value.trim();
            const images = [...selectedImagesData]; // Clone array
            const hasImages = images.length > 0;

            if ((!content && !hasImages) || !isConnected || isProcessing) return;

            isProcessing = true;
            sendBtn.disabled = true;

            // Display user message details
            // Pass content and images
            addUserMessage(content, null, null, images);

            messageInput.value = '';
            messageInput.style.height = 'auto';
            clearSelectedImages();

            // Show thinking spinner immediately
            currentAssistantMessage = createAssistantMessage();
            currentAssistantText = '';

            // If no session, create one first
            if (!currentSessionId) {
                fetch(`${API_BASE}/api/sessions`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                    .then(r => r.json())
                    .then(data => {
                        currentSessionId = data.session.id;
                        sendToWebSocket(content, images);
                    });
            } else {
                sendToWebSocket(content, images);
            }
        }

        function sendToWebSocket(content, images = []) {
            const payload = {
                type: 'message',
                content: content,
                session_id: currentSessionId
            };

            // Add images data if present
            if (images && images.length > 0) {
                payload.images = images;
            }

            ws.send(JSON.stringify(payload));
        }

        // Event listeners
        sendBtn.addEventListener('click', sendMessage);

        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 150) + 'px';
            updateSendButtonState();  // Update send button based on content
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await fetch(`${API_BASE}/api/auth/logout`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
            } catch (e) { }

            localStorage.removeItem('agentry_token');
            window.location.href = '/login';
        });

        // Mobile menu
        document.getElementById('mobile-menu-btn')?.addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebar-overlay').classList.toggle('active');
        });

        document.getElementById('sidebar-overlay')?.addEventListener('click', () => {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebar-overlay').classList.remove('active');
        });

        // Keep-alive ping
        setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'ping' }));
            }
        }, 30000);

        // ============== Tool Approval Modal Functions ==============
        let approvalTimeoutId = null;
        let approvalCountdown = 120;

        function showApprovalModal(toolName, args) {
            const overlay = document.getElementById('approval-modal-overlay');
            const toolNameEl = document.getElementById('approval-tool-name');
            const argsEl = document.getElementById('approval-args');
            const timeoutEl = document.getElementById('approval-timeout');
            const approveBtn = document.getElementById('approval-approve-btn');
            const denyBtn = document.getElementById('approval-deny-btn');

            // Set content
            toolNameEl.textContent = ` ${toolName}`;
            argsEl.textContent = JSON.stringify(args, null, 2);

            // Show modal
            overlay.classList.add('active');

            // Start countdown
            approvalCountdown = 120;
            updateCountdown();

            approvalTimeoutId = setInterval(() => {
                approvalCountdown--;
                updateCountdown();
                if (approvalCountdown <= 0) {
                    clearInterval(approvalTimeoutId);
                    sendApprovalResponse(false);
                }
            }, 1000);

            // Button handlers (remove old handlers first)
            const newApproveBtn = approveBtn.cloneNode(true);
            approveBtn.parentNode.replaceChild(newApproveBtn, approveBtn);
            newApproveBtn.addEventListener('click', () => {
                sendApprovalResponse(true);
            });

            const newDenyBtn = denyBtn.cloneNode(true);
            denyBtn.parentNode.replaceChild(newDenyBtn, denyBtn);
            newDenyBtn.addEventListener('click', () => {
                sendApprovalResponse(false);
            });
            function updateCountdown() {
                timeoutEl.textContent = `Auto-deny in ${approvalCountdown}s`;
            }
        }

        // Media Library functions
        let allMediaItems = []; // Store all media for gallery

        async function loadMedia() {
            try {
                const response = await fetch(`${API_BASE}/api/media`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    allMediaItems = data.media || [];
                    renderMedia(allMediaItems);
                }
            } catch (error) {
                console.error('Failed to load media:', error);
            }
        }

        function renderMedia(mediaList) {
            const container = document.getElementById('media-container');
            const viewAllBtn = document.getElementById('media-view-all-btn');
            if (!container) return;

            container.innerHTML = '';

            if (!mediaList || mediaList.length === 0) {
                container.innerHTML = '<div class="no-media-text">No media uploaded yet</div>';
                if (viewAllBtn) viewAllBtn.style.display = 'none';
                return;
            }

            // Show only 4 recent items in sidebar
            const recentItems = mediaList.slice(0, 4);
            recentItems.forEach(item => {
                addMediaItem(item, false);
            });

            // Show View All button if there are media items
            if (viewAllBtn) {
                viewAllBtn.style.display = 'flex';
            }
        }

        function addMediaItem(item, prepend = true) {
            const container = document.getElementById('media-container');
            if (!container) return;

            // Remove empty state if exists
            const emptyState = container.querySelector('.no-media-text');
            if (emptyState) emptyState.remove();

            const mediaEl = document.createElement('div');
            mediaEl.className = 'media-item';
            mediaEl.id = `media-${item.id}`;
            mediaEl.dataset.mediaId = item.id;

            // Format time
            const date = new Date(item.created_at + (item.created_at.includes('Z') ? '' : 'Z'));
            const timeStr = date.toLocaleString([], {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            mediaEl.innerHTML = `
                <button class="media-delete-btn" title="Delete" onclick="event.stopPropagation(); deleteMediaItem(${item.id});">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
                <img src="${item.url}" alt="${item.filename}" />
                <div class="media-info-overlay">
                    <div class="media-time">${timeStr}</div>
                </div>
            `;

            mediaEl.onclick = (e) => {
                // Don't open if clicking the delete button
                if (e.target.closest('.media-delete-btn')) return;
                window.open(item.url, '_blank');
            };

            if (prepend) {
                container.prepend(mediaEl);
            } else {
                container.appendChild(mediaEl);
            }
        }

        // Media Gallery Modal Functions
        function openMediaGallery() {
            const overlay = document.getElementById('media-gallery-overlay');
            const masonry = document.getElementById('media-masonry');

            if (!overlay || !masonry) return;

            overlay.classList.add('active');
            renderMediaGallery(allMediaItems);

            // Add escape key handler
            document.addEventListener('keydown', handleGalleryEscape);
        }

        function closeMediaGallery() {
            const overlay = document.getElementById('media-gallery-overlay');
            if (overlay) {
                overlay.classList.remove('active');
            }
            document.removeEventListener('keydown', handleGalleryEscape);
        }

        function handleGalleryEscape(e) {
            if (e.key === 'Escape') {
                closeMediaGallery();
            }
        }

        function renderMediaGallery(mediaList) {
            const masonry = document.getElementById('media-masonry');
            if (!masonry) return;

            masonry.innerHTML = '';

            if (!mediaList || mediaList.length === 0) {
                masonry.innerHTML = `
                    <div class="media-gallery-empty">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                        <p>No media files yet</p>
                    </div>
                `;
                return;
            }

            mediaList.forEach(item => {
                add3DCardToGallery(item, masonry);
            });
        }

        function add3DCardToGallery(item, container) {
            const date = new Date(item.created_at + (item.created_at.includes('Z') ? '' : 'Z'));
            const dateStr = date.toLocaleDateString([], {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const card = document.createElement('div');
            card.className = 'media-3d-card';
            card.id = `gallery-media-${item.id}`;

            card.innerHTML = `
                <div class="media-3d-card-inner">
                    <img src="${item.url}" alt="${item.filename}" loading="lazy" />
                    <div class="media-3d-card-overlay">
                        <div class="media-3d-card-date">${dateStr}</div>
                        <div class="media-3d-card-actions">
                            <button class="media-3d-card-btn" onclick="window.open('${item.url}', '_blank')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                    <polyline points="15 3 21 3 21 9"></polyline>
                                    <line x1="10" y1="14" x2="21" y2="3"></line>
                                </svg>
                                Open
                            </button>
                            <button class="media-3d-card-btn delete" onclick="deleteMediaFromGallery(${item.id})">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Add 3D tilt effect on mouse move
            const inner = card.querySelector('.media-3d-card-inner');
            inner.addEventListener('mousemove', (e) => {
                const rect = inner.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                const rotateX = (y - centerY) / 10;
                const rotateY = (centerX - x) / 10;

                inner.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.02)`;
            });

            inner.addEventListener('mouseleave', () => {
                inner.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale(1)';
            });

            container.appendChild(card);
        }

        async function deleteMediaFromGallery(mediaId) {
            if (!confirm('Are you sure you want to delete this media file?')) {
                return;
            }

            const galleryCard = document.getElementById(`gallery-media-${mediaId}`);
            const sidebarItem = document.getElementById(`media-${mediaId}`);

            // Add loading state
            if (galleryCard) {
                galleryCard.style.opacity = '0.5';
                galleryCard.style.pointerEvents = 'none';
            }

            try {
                const response = await fetch(`${API_BASE}/api/media/${mediaId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    // Remove from allMediaItems
                    allMediaItems = allMediaItems.filter(m => m.id !== mediaId);

                    // Remove from gallery with animation
                    if (galleryCard) {
                        galleryCard.style.transform = 'scale(0.8)';
                        galleryCard.style.opacity = '0';
                        setTimeout(() => {
                            galleryCard.remove();
                            // Check if gallery is empty
                            const masonry = document.getElementById('media-masonry');
                            if (masonry && masonry.children.length === 0) {
                                renderMediaGallery([]);
                            }
                        }, 300);
                    }

                    // Also remove from sidebar
                    if (sidebarItem) {
                        sidebarItem.remove();
                    }

                    // Re-render sidebar with updated items
                    renderMedia(allMediaItems);

                } else {
                    const errorData = await response.json();
                    alert(`Failed to delete: ${errorData.detail || 'Unknown error'}`);
                    if (galleryCard) {
                        galleryCard.style.opacity = '1';
                        galleryCard.style.pointerEvents = 'auto';
                    }
                }
            } catch (error) {
                console.error('Failed to delete media:', error);
                alert('Failed to delete media. Please try again.');
                if (galleryCard) {
                    galleryCard.style.opacity = '1';
                    galleryCard.style.pointerEvents = 'auto';
                }
            }
        }

        async function deleteMediaItem(mediaId) {
            if (!confirm('Are you sure you want to delete this media file?')) {
                return;
            }

            const mediaEl = document.getElementById(`media-${mediaId}`);
            if (mediaEl) {
                mediaEl.style.opacity = '0.5';
                mediaEl.style.pointerEvents = 'none';
            }

            try {
                const response = await fetch(`${API_BASE}/api/media/${mediaId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    // Remove from allMediaItems
                    allMediaItems = allMediaItems.filter(m => m.id !== mediaId);

                    // Remove from DOM with animation
                    if (mediaEl) {
                        mediaEl.style.transform = 'scale(0.8)';
                        mediaEl.style.opacity = '0';
                        setTimeout(() => {
                            mediaEl.remove();
                            // Re-render to show next item if available
                            renderMedia(allMediaItems);
                        }, 200);
                    }
                } else {
                    const errorData = await response.json();
                    alert(`Failed to delete: ${errorData.detail || 'Unknown error'}`);
                    if (mediaEl) {
                        mediaEl.style.opacity = '1';
                        mediaEl.style.pointerEvents = 'auto';
                    }
                }
            } catch (error) {
                console.error('Failed to delete media:', error);
                alert('Failed to delete media. Please try again.');
                if (mediaEl) {
                    mediaEl.style.opacity = '1';
                    mediaEl.style.pointerEvents = 'auto';
                }
            }
        }

        function hideApprovalModal() {
            const overlay = document.getElementById('approval-modal-overlay');
            overlay.classList.remove('active');
            if (approvalTimeoutId) {
                clearInterval(approvalTimeoutId);
                approvalTimeoutId = null;
            }
        }

        function sendApprovalResponse(approved) {
            hideApprovalModal();
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'tool_approval_response',
                    approved: approved
                }));
            }
        }



        function initSidebarControls() {
            const sidebar = document.getElementById('sidebar');
            const resizer = document.getElementById('sidebar-resizer');
            const collapseBtn = document.getElementById('sidebar-collapse-btn');
            const expandBtn = document.getElementById('sidebar-expand-btn');

            // Toggle Logic
            function toggleSidebar(collapsed) {
                if (collapsed) {
                    sidebar.classList.add('collapsed');
                } else {
                    sidebar.classList.remove('collapsed');
                }
            }

            if (collapseBtn) {
                collapseBtn.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleSidebar(true);
                }
            }

            if (expandBtn) {
                expandBtn.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleSidebar(false);
                }
            }

            // Resizing Logic
            if (resizer) {
                let isResizing = false;

                resizer.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    document.body.style.cursor = 'col-resize';
                    sidebar.style.transition = 'none';
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isResizing) return;
                    let newWidth = e.clientX;
                    if (newWidth < 240) newWidth = 240;
                    if (newWidth > 600) newWidth = 600;
                    sidebar.style.width = `${newWidth}px`;
                });

                document.addEventListener('mouseup', () => {
                    if (isResizing) {
                        isResizing = false;
                        document.body.style.cursor = '';
                        sidebar.style.transition = '';
                    }
                });
            }

            // Media Library Toggle
            const mediaToggle = document.getElementById('media-library-toggle');
            const mediaLibraryWrapper = document.getElementById('media-library-wrapper');

            if (mediaToggle && mediaLibraryWrapper) {
                mediaToggle.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const isVisible = mediaLibraryWrapper.style.display !== 'none';
                    mediaLibraryWrapper.style.display = isVisible ? 'none' : 'block';
                    mediaToggle.classList.toggle('active', !isVisible);
                };

                // Close on outside click
                document.addEventListener('click', (e) => {
                    const isVisible = mediaLibraryWrapper.style.display !== 'none';
                    if (isVisible && !mediaLibraryWrapper.contains(e.target) && !mediaToggle.contains(e.target)) {
                        mediaLibraryWrapper.style.display = 'none';
                        mediaToggle.classList.remove('active');
                    }
                });
            }

            // Media Gallery Modal - View All Button
            const viewAllBtn = document.getElementById('media-view-all-btn');
            if (viewAllBtn) {
                viewAllBtn.onclick = (e) => {
                    e.preventDefault();
                    openMediaGallery();
                };
            }

            // Media Gallery Modal - Close Button
            const galleryClose = document.getElementById('media-gallery-close');
            if (galleryClose) {
                galleryClose.onclick = (e) => {
                    e.preventDefault();
                    closeMediaGallery();
                };
            }

            // Media Gallery Modal - Click outside to close
            const galleryOverlay = document.getElementById('media-gallery-overlay');
            if (galleryOverlay) {
                galleryOverlay.onclick = (e) => {
                    if (e.target === galleryOverlay) {
                        closeMediaGallery();
                    }
                };
            }
        }

        async function copyToClipboard(text, btnElement) {
            try {
                await navigator.clipboard.writeText(text);

                // Visual feedback - show checkmark SVG
                const originalHtml = btnElement.innerHTML;
                btnElement.innerHTML = `
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                `;
                btnElement.classList.add('copied');

                setTimeout(() => {
                    btnElement.innerHTML = originalHtml;
                    btnElement.classList.remove('copied');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
            }
        }


        // Initialize
        init();
    </script>

</body>

</html>